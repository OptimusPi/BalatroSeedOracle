<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BalatroSeedOracle.ViewModels.Controls"
             xmlns:icons="https://github.com/MahApps/IconPacks.Avalonia"
             x:Class="BalatroSeedOracle.Controls.SortableResultsGrid"
             x:DataType="vm:SortableResultsGridViewModel"
             x:CompileBindings="True">

    <UserControl.Resources>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header with sorting controls -->
        <Border Grid.Row="0" 
                Background="{StaticResource DarkBackground}" 
                BorderBrush="{StaticResource ModalBorder}" 
                BorderThickness="0,0,0,2" 
                Padding="12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="15">
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                        <icons:PackIconMaterial Kind="Magnify" Width="18" Height="18" Foreground="{StaticResource White}"/>
                        <TextBlock Text="SEARCH RESULTS"
                                   Foreground="{StaticResource White}"
                                   FontFamily="{StaticResource BalatroFont}"
                                   FontSize="18"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <TextBlock Text="{Binding ResultsCountText}"
                               Foreground="{StaticResource Gold}"
                               FontSize="14"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                    <!-- Sort controls -->
                    <TextBlock Text="Sort by:"
                               Foreground="{StaticResource White}"
                               FontSize="12"
                               VerticalAlignment="Center"/>

                    <ComboBox SelectedIndex="{Binding SelectedSortIndex}"
                              Background="{StaticResource DarkBackground}"
                              Foreground="{StaticResource Gold}"
                              BorderBrush="{StaticResource ModalBorder}"
                              MinWidth="160">
                        <ComboBoxItem Content="Seed"/>
                        <ComboBoxItem Content="Score ↓"/>
                        <ComboBoxItem Content="Score ↑"/>
                    </ComboBox>

                    <!-- Export button -->
                    <Button Command="{Binding ExportAllCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <icons:PackIconMaterial Kind="Export" Width="14" Height="14"/>
                            <TextBlock Text="Export" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- Pop Out button -->
                    <Button Command="{Binding PopOutCommand}"
                            ToolTip.Tip="Open results in separate window">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <icons:PackIconMaterial Kind="OpenInNew" Width="14" Height="14"/>
                            <TextBlock Text="Pop Out" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Main DataGrid -->
        <DataGrid Grid.Row="1"
                  Name="ResultsDataGrid"
                  ItemsSource="{Binding DisplayedResults}"
                  AutoGenerateColumns="False"
                  CanUserReorderColumns="True"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="True"
                  IsReadOnly="True"
                  SelectionMode="Extended"
                  MinHeight="200"
                  RowHeight="36"
                  Background="{StaticResource DarkBackground}"
                  Foreground="{StaticResource White}"
                  RowBackground="#404040"
                  GridLinesVisibility="Horizontal"
                  HorizontalGridLinesBrush="#606060"
                  HeadersVisibility="Column"
                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                  ScrollViewer.HorizontalScrollBarVisibility="Auto">
            <DataGrid.Columns>
                <!-- Seed column with copy button -->
                <DataGridTemplateColumn Header="SEED" Width="150" SortMemberPath="Seed">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="5">
                                <TextBlock Text="{Binding Seed}"
                                           FontFamily="Consolas"
                                           FontSize="12"
                                           Foreground="{StaticResource White}"
                                           VerticalAlignment="Center"/>
                                <Button Classes="copy-btn"
                                        ToolTip.Tip="Copy seed to clipboard"
                                        Command="{Binding $parent[UserControl].DataContext.CopySeedCommand}"
                                        CommandParameter="{Binding Seed}">
                                    <icons:PackIconMaterial Kind="ContentCopy" Width="12" Height="12"/>
                                </Button>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Score column - using template for explicit foreground -->
                <DataGridTemplateColumn Header="SCORE" Width="80" SortMemberPath="TotalScore">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding TotalScore}"
                                       FontFamily="Consolas"
                                       FontSize="12"
                                       Foreground="{StaticResource Gold}"
                                       VerticalAlignment="Center"
                                       HorizontalAlignment="Center"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                
                <!-- Tally columns will be added dynamically based on Labels/Scores -->
                
                <!-- Actions column -->
                <DataGridTemplateColumn Header="ACTIONS" Width="90">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="5">
                                <Button Classes="copy-btn"
                                        ToolTip.Tip="Copy seed"
                                        Command="{Binding $parent[UserControl].DataContext.CopySeedCommand}"
                                        CommandParameter="{Binding Seed}">
                                    <icons:PackIconMaterial Kind="ContentCopy" Width="12" Height="12"/>
                                </Button>
                                <Button Classes="copy-btn"
                                        ToolTip.Tip="Analyze seed"
                                        Command="{Binding $parent[UserControl].DataContext.AnalyzeCommand}"
                                        CommandParameter="{Binding}">
                                    <icons:PackIconMaterial Kind="ChartBar" Width="12" Height="12"/>
                                </Button>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>
        
        <!-- Footer with stats -->
        <Border Grid.Row="2"
                Background="{StaticResource DarkBackground}"
                BorderBrush="{StaticResource ModalBorder}"
                BorderThickness="0,2,0,0"
                Padding="12">
            <TextBlock Text="{Binding StatsText}"
                       Foreground="{StaticResource White}"
                       FontSize="12"
                       VerticalAlignment="Center"/>
        </Border>
    </Grid>
</UserControl>
