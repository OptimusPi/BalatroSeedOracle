<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Balatro Seed Oracle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="stylesheet" href="./app.css" />
    <!-- Import map for DuckDB-WASM dependencies -->
    <script type="importmap">
    {
        "imports": {
            "apache-arrow": "https://cdn.jsdelivr.net/npm/apache-arrow@17.0.0/+esm"
        }
    }
    </script>
    <style>
        .loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #f0f0f0;
            font-family: 'Segoe UI', sans-serif;
        }
        .loading-bar-wrapper {
            width: 300px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        .loading-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #9b59b6, #e67e22);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        .loading-status {
            color: #888;
            font-size: 14px;
            margin-top: 10px;
        }
        .loading-percent {
            color: #e67e22;
            font-size: 18px;
            font-weight: bold;
        }
        .error-display {
            display: none;
            background: #ff0000;
            color: white;
            padding: 30px;
            margin: 20px;
            border-radius: 10px;
            max-width: 800px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            box-shadow: 0 0 30px rgba(255,0,0,0.5);
            border: 3px solid #ff6666;
        }
        .error-display.visible {
            display: block;
        }
        .error-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            font-family: sans-serif;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden; background-color: #1a1a2e;">
<div id="out">
    <div class="loading-container" id="loading-screen">
        <h1 style="color: #9b59b6; margin-bottom: 10px;">JAML</h1>
        <p style="color: #e67e22; margin-bottom: 20px; font-size: 18px;">Joker Ante Markup Language</p>

        <div class="loading-bar-wrapper">
            <div class="loading-bar" id="loading-bar"></div>
        </div>
        <div class="loading-percent" id="loading-percent">0%</div>
        <div class="loading-status" id="loading-status">Initializing...</div>

        <p style="color: #666; font-size: 14px; margin-top: 30px;">Powered by Avalonia UI & pifreak's chaos</p>

        <div class="error-display" id="error-display">
            <div class="error-title">SPECTACULAR FAILURE</div>
            <div id="error-message"></div>
        </div>
    </div>
</div>
<script>
// Loading state management
window.LoadingState = {
    progress: 0,
    status: 'Initializing...',

    setProgress: function(percent, status) {
        this.progress = Math.min(100, Math.max(0, percent));
        if (status) this.status = status;

        document.getElementById('loading-bar').style.width = this.progress + '%';
        document.getElementById('loading-percent').textContent = Math.round(this.progress) + '%';
        document.getElementById('loading-status').textContent = this.status;
        console.log(`[LOADING] ${Math.round(this.progress)}% - ${this.status}`);
    },

    fail: function(error) {
        const errorDisplay = document.getElementById('error-display');
        const errorMessage = document.getElementById('error-message');

        let errorText = '';
        if (error instanceof Error) {
            errorText = `${error.name}: ${error.message}\n\nStack:\n${error.stack || 'No stack trace'}`;
        } else if (typeof error === 'string') {
            errorText = error;
        } else {
            errorText = JSON.stringify(error, null, 2);
        }

        errorMessage.textContent = errorText;
        errorDisplay.classList.add('visible');
        document.getElementById('loading-status').textContent = 'FAILED';
        document.getElementById('loading-status').style.color = '#ff0000';

        console.error('[FATAL ERROR]', error);
    }
};

// Catch ALL errors
window.addEventListener('error', (e) => {
    console.error("Global error:", e.message, e.filename, e.lineno, e.colno, e.error);
    window.LoadingState.fail(`${e.message}\n\nFile: ${e.filename}\nLine: ${e.lineno}:${e.colno}`);
});

window.addEventListener('unhandledrejection', (e) => {
    console.error("Unhandled promise rejection:", e.reason);
    window.LoadingState.fail(e.reason);
});

// Start loading
window.LoadingState.setProgress(5, 'Loading scripts...');
</script>

<!-- DuckDB-WASM interop module -->
<script type="module">
    import './js/duckdb-interop.js';
    window.LoadingState.setProgress(15, 'DuckDB module loaded');
</script>

<!-- .NET WASM Bootstrap -->
<script type="module">
    window.LoadingState.setProgress(20, 'Loading .NET runtime...');

    try {
        // Import and configure dotnet
        import('./_framework/dotnet.js').then(async ({ dotnet }) => {
            window.LoadingState.setProgress(30, '.NET module imported');

            try {
                // Configure the runtime with progress callbacks
                const runtime = await dotnet
                    .withDiagnosticTracing(false)
                    .withResourceLoader((type, name, defaultUri, integrity, behavior) => {
                        // Track assembly loading progress
                        if (type === 'assembly') {
                            const currentProgress = window.LoadingState.progress;
                            if (currentProgress < 90) {
                                window.LoadingState.setProgress(currentProgress + 0.5, `Loading ${name}...`);
                            }
                        }
                        return defaultUri;
                    })
                    .create();

                window.LoadingState.setProgress(95, 'Starting Avalonia...');

                await runtime.runMain();

                window.LoadingState.setProgress(100, 'Ready!');
                console.log('.NET runtime started successfully');

            } catch (runtimeError) {
                window.LoadingState.fail(runtimeError);
            }
        }).catch(importError => {
            window.LoadingState.fail(importError);
        });

    } catch (err) {
        window.LoadingState.fail(err);
    }
</script>
</body>
</html>
