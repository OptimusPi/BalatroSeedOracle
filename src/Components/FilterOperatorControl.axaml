<UserControl
    x:Class="BalatroSeedOracle.Components.FilterOperatorControl"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:BalatroSeedOracle.Models"
    x:DataType="models:FilterOperatorItem">

    <UserControl.Styles>
        <!-- Expansion animation on hover -->
        <Style Selector="Border#OperatorContainer:pointerover">
            <Setter Property="MinWidth" Value="220"/>
            <Setter Property="MinHeight" Value="140"/>
            <Setter Property="BorderThickness" Value="3"/>
        </Style>

        <!-- Balatro-style highlight when dragging over - white border with colored overlay -->
        <Style Selector="Border#OperatorContainer.drag-over">
            <Setter Property="BorderBrush" Value="#FFFFFF"/>
            <Setter Property="BorderThickness" Value="3"/>
            <Setter Property="MinWidth" Value="220"/>
            <Setter Property="MinHeight" Value="140"/>
        </Style>

        <!-- Semi-transparent overlay for drop zone -->
        <Style Selector="Border#ChildrenDropZone.drag-active">
            <Setter Property="Background">
                <Setter.Value>
                    <SolidColorBrush Color="#4CAF50" Opacity="0.3"/>
                </Setter.Value>
            </Setter>
            <Setter Property="BorderBrush" Value="#FFFFFF"/>
            <Setter Property="BorderThickness" Value="2"/>
        </Style>
    </UserControl.Styles>

    <Border
        Name="OperatorContainer"
        Padding="0"
        Background="Transparent"
        BorderThickness="2"
        CornerRadius="8"
        MinWidth="160"
        MinHeight="100"
        ClipToBounds="False">
        <Border.Transitions>
            <Transitions>
                <DoubleTransition Property="MinWidth" Duration="0:0:0.3" Easing="CubicEaseOut"/>
                <DoubleTransition Property="MinHeight" Duration="0:0:0.3" Easing="CubicEaseOut"/>
                <ThicknessTransition Property="BorderThickness" Duration="0:0:0.2"/>
            </Transitions>
        </Border.Transitions>

        <Grid RowDefinitions="Auto,*">
            <!-- Operator Label Header - Flat connected style (dynamic color based on operator type) -->
            <Border
                Name="OperatorHeader"
                Grid.Row="0"
                Padding="12,6"
                CornerRadius="6,6,0,0"
                HorizontalAlignment="Stretch"
                Cursor="Hand">
                <TextBlock
                    Text="{Binding OperatorType}"
                    FontSize="14"
                    FontFamily="{StaticResource BalatroFont}"
                    
                    Foreground="{StaticResource White}"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center" />
            </Border>

            <!-- Fanned Cards Container -->
            <Border
                Grid.Row="1"
                Name="ChildrenDropZone"
                Padding="12"
                Background="{StaticResource DarkBackground}"
                BorderThickness="0"
                CornerRadius="0,0,6,6"
                MinHeight="80"
                ClipToBounds="False"
                DragDrop.AllowDrop="True">

                <!-- Canvas for absolute positioning of fanned cards -->
                <Canvas Name="FannedCardsCanvas"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        MinWidth="160"
                        MinHeight="80"
                        ClipToBounds="False">
                    <ItemsControl
                        Name="ChildrenItemsControl"
                        ItemsSource="{Binding Children}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <!-- Fanned card with rotation and offset -->
                                <Border Background="Transparent"
                                        RenderTransformOrigin="0.5,1.0"
                                        ToolTip.Tip="{Binding DisplayName}"
                                        Cursor="Hand">
                                    <Border.RenderTransform>
                                        <TransformGroup>
                                            <RotateTransform Angle="0"/>
                                            <TranslateTransform X="0" Y="0"/>
                                        </TransformGroup>
                                    </Border.RenderTransform>

                                    <Grid Width="40" Height="56">
                                        <Image
                                            Source="{Binding ItemImage}"
                                            Stretch="Uniform"
                                            IsHitTestVisible="False"/>
                                        <!-- Soul face overlay for legendary jokers -->
                                        <Image
                                            Source="{Binding SoulFaceImage}"
                                            Stretch="Uniform"
                                            IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"
                                            IsHitTestVisible="False"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Canvas>
            </Border>
        </Grid>
    </Border>
</UserControl>
