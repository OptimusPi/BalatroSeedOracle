<UserControl
    x:Class="BalatroSeedOracle.Components.FilterOperatorControl"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:BalatroSeedOracle.Models"
    xmlns:converters="using:BalatroSeedOracle.Converters"
    x:DataType="models:FilterOperatorItem">

    <UserControl.Styles>
        <!-- Operator card container base style -->
        <Style Selector="Border.operator-card-container">
            <Setter Property="BorderBrush" Value="{StaticResource Blue}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Background" Value="{StaticResource DarkBackground}"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="MinHeight" Value="100"/>
        </Style>

        <!-- BannedItems container - RED theme -->
        <Style Selector="Border.operator-card-container.banned">
            <Setter Property="BorderBrush" Value="{StaticResource Red}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Background" Value="{StaticResource DarkBackground}"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="MinHeight" Value="100"/>
        </Style>

        <!-- Expansion animation on hover -->
        <Style Selector="Border.operator-card-container:pointerover">
            <Setter Property="MinWidth" Value="240"/>
            <Setter Property="MinHeight" Value="180"/>
            <Setter Property="BorderThickness" Value="3"/>
        </Style>

        <!-- Balatro-style highlight when dragging over -->
        <Style Selector="Border.operator-card-container.drag-over">
            <Setter Property="BorderBrush" Value="{StaticResource White}"/>
            <Setter Property="BorderThickness" Value="3"/>
            <Setter Property="MinWidth" Value="240"/>
            <Setter Property="MinHeight" Value="180"/>
        </Style>

        <!-- Operator header style -->
        <Style Selector="Border.operator-header">
            <Setter Property="Background" Value="{StaticResource Blue}"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="CornerRadius" Value="6,6,0,0"/>
        </Style>

        <!-- BannedItems header - RED background -->
        <Style Selector="Border.operator-header.banned">
            <Setter Property="Background" Value="{StaticResource Red}"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="CornerRadius" Value="6,6,0,0"/>
        </Style>

        <!-- Operator label text style -->
        <Style Selector="TextBlock.operator-label">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontFamily" Value="{StaticResource BalatroFont}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- Semi-transparent overlay for drop zone feedback -->
        <Style Selector="Border.operator-drop-zone.drag-active">
            <Setter Property="Background">
                <Setter.Value>
                    <SolidColorBrush Color="{StaticResource ColorBlue}" Opacity="0.3"/>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Styles>

    <Border
        Name="OperatorContainer"
        Classes="operator-card-container"
        Classes.banned="{Binding OperatorType, Converter={x:Static converters:IsBannedItemsConverter.Instance}}"
        ClipToBounds="False">
        <Border.Transitions>
            <Transitions>
                <DoubleTransition Property="MinWidth" Duration="0:0:0.3" Easing="CubicEaseOut"/>
                <DoubleTransition Property="MinHeight" Duration="0:0:0.3" Easing="CubicEaseOut"/>
                <ThicknessTransition Property="BorderThickness" Duration="0:0:0.2"/>
            </Transitions>
        </Border.Transitions>

        <Grid RowDefinitions="Auto,*">
            <!-- Header with OR/AND/Banned Items Label -->
            <Border
                Name="OperatorHeader"
                Grid.Row="0"
                Classes="operator-header"
                Classes.banned="{Binding OperatorType, Converter={x:Static converters:IsBannedItemsConverter.Instance}}"
                Cursor="Hand">
                <TextBlock
                    Text="{Binding DisplayName}"
                    Classes="operator-label" />
            </Border>

            <!-- Fanned Cards Container -->
            <Border
                Grid.Row="1"
                Name="ChildrenDropZone"
                Classes="operator-drop-zone"
                Padding="12,8"
                Background="Transparent"
                BorderThickness="0"
                CornerRadius="0,0,6,6"
                MinHeight="100"
                ClipToBounds="False"
                DragDrop.AllowDrop="True">

                <!-- Canvas for absolute positioning of fanned cards -->
                <Canvas Name="FannedCardsCanvas"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        MinWidth="120"
                        MinHeight="100"
                        ClipToBounds="False">
                    <ItemsControl
                        Name="ChildrenItemsControl"
                        ItemsSource="{Binding Children}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <!-- Fanned card with rotation and offset (poker hand style) -->
                                <Border Background="Transparent"
                                        RenderTransformOrigin="0.5,1.0"
                                        ToolTip.Tip="{Binding DisplayName}"
                                        Cursor="Hand">
                                    <Border.RenderTransform>
                                        <TransformGroup>
                                            <RotateTransform Angle="0"/>
                                            <TranslateTransform X="0" Y="0"/>
                                        </TransformGroup>
                                    </Border.RenderTransform>

                                    <!-- Slightly larger cards (50x70 instead of 40x56) for better visibility -->
                                    <Grid Width="50" Height="70">
                                        <!-- Base card image -->
                                        <Image
                                            Source="{Binding ItemImage}"
                                            Stretch="Uniform"
                                            IsHitTestVisible="False"/>

                                        <!-- Soul face overlay for legendary jokers -->
                                        <Image
                                            Source="{Binding SoulFaceImage}"
                                            Stretch="Uniform"
                                            IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"
                                            IsHitTestVisible="False"/>

                                        <!-- DEBUFFED overlay (FULL SIZE) - only for BannedItems tray -->
                                        <Image
                                            Source="{Binding DebuffedOverlayImage}"
                                            Stretch="Uniform"
                                            IsVisible="{Binding IsInBannedItemsTray}"
                                            IsHitTestVisible="False"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Canvas>
            </Border>
        </Grid>
    </Border>
</UserControl>
