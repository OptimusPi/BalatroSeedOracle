<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BalatroSeedOracle.ViewModels"
             x:Class="BalatroSeedOracle.Components.AudioVisualizerSettingsWidget"
             x:DataType="vm:AudioVisualizerSettingsWidgetViewModel"
             x:CompileBindings="True">

    <UserControl.Styles>
        <Style Selector="Border.widget-container">
            <Setter Property="Background" Value="#CC2e3f42"/>
            <Setter Property="BorderBrush" Value="{StaticResource ModalBorder}"/>
            <Setter Property="BorderThickness" Value="3"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="BoxShadow" Value="0 4 0 #1a1a1a"/>
        </Style>

        <Style Selector="Border.widget-header">
            <Setter Property="Background" Value="#DD1a2428"/>
            <Setter Property="CornerRadius" Value="8,8,0,0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <Style Selector="Border.content-area">
            <Setter Property="Background" Value="#F5FFFFFF"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="BoxShadow" Value="0 2 8 #44000000"/>
        </Style>
    </UserControl.Styles>

    <Grid>
        <!-- Minimized State - Compact Music Icon -->
        <Grid Name="MinimizedView"
              IsVisible="{Binding IsMinimized}"
              Margin="10,10,0,0"
              PointerPressed="OnWidgetPointerPressed"
              PointerMoved="OnWidgetPointerMoved"
              PointerReleased="OnWidgetPointerReleased">
            <Button Background="{StaticResource Red}"
                    BorderBrush="{StaticResource ModalBorder}"
                    BorderThickness="3"
                    CornerRadius="12"
                    Width="100" Height="100"
                    Cursor="Hand"
                    Command="{Binding ToggleMinimizeCommand}">
                <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                    <TextBlock Text="ðŸŽµ" FontSize="20" VerticalAlignment="Center"/>
                    <TextBlock Text="Audio" FontSize="13" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Expanded State - Full Settings Panel -->
        <Border Name="ExpandedView"
                Classes="widget-container"
                IsVisible="{Binding !IsMinimized}"
                MinWidth="420"
                MaxWidth="520"
                Margin="10,10,0,0"
                PointerPressed="OnWidgetPointerPressed"
                PointerMoved="OnWidgetPointerMoved"
                PointerReleased="OnWidgetPointerReleased">

            <Grid RowDefinitions="Auto,*">
                <!-- Header with Title and Minimize Button -->
                <Border Grid.Row="0" Classes="widget-header" Padding="12,8">
                    <Grid ColumnDefinitions="*,Auto">
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="ðŸŽµ" FontSize="16" VerticalAlignment="Center"/>
                            <TextBlock Text="Audio Visualizer Settings"
                                       FontSize="14"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       VerticalAlignment="Center"/>
                        </StackPanel>

                        <Button Grid.Column="1"
                                Content="_"
                                Command="{Binding ToggleMinimizeCommand}"
                                FontSize="16"
                                FontWeight="Bold"
                                Foreground="White"
                                Background="Transparent"
                                BorderThickness="0"
                                Padding="8,0"
                                Cursor="Hand"
                                ToolTip.Tip="Minimize"/>
                    </Grid>
                </Border>

                <!-- Content Area with ScrollViewer -->
                <ScrollViewer Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled"
                              MaxHeight="480"
                              Padding="15">

                    <Border Classes="content-area" Padding="15">
                        <StackPanel Spacing="16">

                            <!-- THEME SELECTION -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="Theme" Foreground="#2e3f42" FontWeight="Bold" FontSize="13"/>
                                <ComboBox SelectedIndex="{Binding ThemeIndex}" HorizontalAlignment="Stretch" FontSize="12">
                                    <ComboBoxItem Content="Default"/>
                                    <ComboBoxItem Content="Wave Rider"/>
                                    <ComboBoxItem Content="Inferno"/>
                                    <ComboBoxItem Content="Frozen"/>
                                    <ComboBoxItem Content="Rainbow Cascade"/>
                                    <ComboBoxItem Content="Electric Storm"/>
                                    <ComboBoxItem Content="Sakura Dream"/>
                                    <ComboBoxItem Content="Lunar Eclipse"/>
                                    <ComboBoxItem Content="CUSTOMIZE..."/>
                                </ComboBox>
                            </StackPanel>

                            <!-- CUSTOM COLORS (only shown when CUSTOMIZE selected) -->
                            <StackPanel Spacing="10" IsVisible="{Binding IsCustomTheme}">
                                <TextBlock Text="Custom Colors" Foreground="#ff4c40" FontWeight="Bold" FontSize="12"/>
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                    <StackPanel Grid.Column="0" Spacing="4">
                                        <TextBlock Text="Main" Foreground="#4a4a4a" FontSize="11"/>
                                        <ComboBox SelectedIndex="{Binding MainColor}" HorizontalAlignment="Stretch" FontSize="11">
                                            <ComboBoxItem Content="Red"/>
                                            <ComboBoxItem Content="Orange"/>
                                            <ComboBoxItem Content="Yellow"/>
                                            <ComboBoxItem Content="Green"/>
                                            <ComboBoxItem Content="Blue"/>
                                            <ComboBoxItem Content="Purple"/>
                                            <ComboBoxItem Content="Brown"/>
                                            <ComboBoxItem Content="White"/>
                                            <ComboBoxItem Content="None"/>
                                        </ComboBox>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Spacing="4">
                                        <TextBlock Text="Accent" Foreground="#4a4a4a" FontSize="11"/>
                                        <ComboBox SelectedIndex="{Binding AccentColor}" HorizontalAlignment="Stretch" FontSize="11">
                                            <ComboBoxItem Content="Red"/>
                                            <ComboBoxItem Content="Orange"/>
                                            <ComboBoxItem Content="Yellow"/>
                                            <ComboBoxItem Content="Green"/>
                                            <ComboBoxItem Content="Blue"/>
                                            <ComboBoxItem Content="Purple"/>
                                            <ComboBoxItem Content="Brown"/>
                                            <ComboBoxItem Content="White"/>
                                            <ComboBoxItem Content="None"/>
                                        </ComboBox>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>

                            <!-- INTENSITY SLIDERS -->
                            <StackPanel Spacing="10">
                                <TextBlock Text="Intensity" Foreground="#2e3f42" FontWeight="Bold" FontSize="13"/>

                                <!-- Music Sensitivity -->
                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                    <TextBlock Grid.Column="0" Text="Music" Foreground="#4a4a4a" VerticalAlignment="Center" FontSize="11" MinWidth="90"/>
                                    <Slider Grid.Column="1" Value="{Binding AudioIntensity}" Minimum="0" Maximum="2" VerticalAlignment="Center"/>
                                    <Border Grid.Column="2" Background="#ff4c40" CornerRadius="4" Padding="6,3" MinWidth="40">
                                        <TextBlock Text="{Binding AudioIntensityNumeric}" Foreground="White" FontWeight="Bold" FontSize="10" HorizontalAlignment="Center"/>
                                    </Border>
                                </Grid>

                                <!-- Parallax -->
                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                    <TextBlock Grid.Column="0" Text="Parallax" Foreground="#4a4a4a" VerticalAlignment="Center" FontSize="11" MinWidth="90"/>
                                    <Slider Grid.Column="1" Value="{Binding ParallaxStrength}" Minimum="0" Maximum="2" VerticalAlignment="Center"/>
                                    <Border Grid.Column="2" Background="#ff4c40" CornerRadius="4" Padding="6,3" MinWidth="40">
                                        <TextBlock Text="{Binding ParallaxNumeric}" Foreground="White" FontWeight="Bold" FontSize="10" HorizontalAlignment="Center"/>
                                    </Border>
                                </Grid>

                                <!-- Speed -->
                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                    <TextBlock Grid.Column="0" Text="Speed" Foreground="#4a4a4a" VerticalAlignment="Center" FontSize="11" MinWidth="90"/>
                                    <Slider Grid.Column="1" Value="{Binding TimeSpeed}" Minimum="0" Maximum="3" VerticalAlignment="Center"/>
                                    <Border Grid.Column="2" Background="#ff4c40" CornerRadius="4" Padding="6,3" MinWidth="40">
                                        <TextBlock Text="{Binding TimeSpeedNumeric}" Foreground="White" FontWeight="Bold" FontSize="10" HorizontalAlignment="Center"/>
                                    </Border>
                                </Grid>
                            </StackPanel>

                            <!-- PRESETS -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="Presets" Foreground="#2e3f42" FontWeight="Bold" FontSize="13"/>
                                <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="6">
                                    <ComboBox Grid.Column="0" ItemsSource="{Binding Presets}" SelectedItem="{Binding SelectedPreset}" HorizontalAlignment="Stretch" FontSize="11">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Name}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    <Button Grid.Column="1" Content="Load" Command="{Binding LoadPresetCommand}" Classes="btn-blue" Padding="8,4" FontSize="11"/>
                                    <Button Grid.Column="2" Content="Save" Command="{Binding SavePresetCommand}" Classes="btn-red" Padding="8,4" FontSize="11"/>
                                </Grid>
                            </StackPanel>

                            <!-- ADVANCED (EXPANDER) -->
                            <Expander Header="âš™ï¸ Advanced Settings" FontSize="12" FontWeight="Bold">
                                <StackPanel Spacing="10" Margin="0,8,0,0">

                                    <!-- Audio Event Triggers -->
                                    <StackPanel Spacing="6">
                                        <TextBlock Text="ðŸ”Š Audio Events" Foreground="#2e3f42" FontWeight="SemiBold" FontSize="11"/>
                                        <CheckBox Content="Seed Found" IsChecked="{Binding SeedFoundTrigger}" Foreground="#4a4a4a" FontSize="10"/>
                                        <CheckBox Content="High Score" IsChecked="{Binding HighScoreSeedTrigger}" Foreground="#4a4a4a" FontSize="10"/>
                                        <CheckBox Content="Search Done" IsChecked="{Binding SearchCompleteTrigger}" Foreground="#4a4a4a" FontSize="10"/>
                                    </StackPanel>

                                    <!-- Beat Detection -->
                                    <StackPanel Spacing="6">
                                        <TextBlock Text="ðŸ¥ Beat Detection" Foreground="#2e3f42" FontWeight="SemiBold" FontSize="11"/>
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                            <TextBlock Grid.Column="0" Text="Threshold" Foreground="#666" FontSize="10" VerticalAlignment="Center" MinWidth="70"/>
                                            <Slider Grid.Column="1" Value="{Binding BeatThreshold}" Minimum="0" Maximum="1" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="2" Text="{Binding BeatThreshold, StringFormat='{}{0:F2}'}" Foreground="#666" FontSize="10" MinWidth="35" HorizontalAlignment="Right"/>
                                        </Grid>
                                    </StackPanel>

                                    <!-- Per-Track Sensitivity -->
                                    <StackPanel Spacing="6">
                                        <TextBlock Text="ðŸŽšï¸ Track Sensitivity" Foreground="#2e3f42" FontWeight="SemiBold" FontSize="11"/>
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                            <TextBlock Grid.Column="0" Text="Drums1" Foreground="#666" FontSize="10" VerticalAlignment="Center" MinWidth="60"/>
                                            <Slider Grid.Column="1" Value="{Binding Drums1Sensitivity}" Minimum="0" Maximum="3"/>
                                            <TextBlock Grid.Column="2" Text="{Binding Drums1Sensitivity, StringFormat='{}{0:F1}x'}" Foreground="#666" FontSize="10" MinWidth="40"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                            <TextBlock Grid.Column="0" Text="Drums2" Foreground="#666" FontSize="10" VerticalAlignment="Center" MinWidth="60"/>
                                            <Slider Grid.Column="1" Value="{Binding Drums2Sensitivity}" Minimum="0" Maximum="3"/>
                                            <TextBlock Grid.Column="2" Text="{Binding Drums2Sensitivity, StringFormat='{}{0:F1}x'}" Foreground="#666" FontSize="10" MinWidth="40"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                            <TextBlock Grid.Column="0" Text="Bass1" Foreground="#666" FontSize="10" VerticalAlignment="Center" MinWidth="60"/>
                                            <Slider Grid.Column="1" Value="{Binding Bass1Sensitivity}" Minimum="0" Maximum="3"/>
                                            <TextBlock Grid.Column="2" Text="{Binding Bass1Sensitivity, StringFormat='{}{0:F1}x'}" Foreground="#666" FontSize="10" MinWidth="40"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                            <TextBlock Grid.Column="0" Text="Bass2" Foreground="#666" FontSize="10" VerticalAlignment="Center" MinWidth="60"/>
                                            <Slider Grid.Column="1" Value="{Binding Bass2Sensitivity}" Minimum="0" Maximum="3"/>
                                            <TextBlock Grid.Column="2" Text="{Binding Bass2Sensitivity, StringFormat='{}{0:F1}x'}" Foreground="#666" FontSize="10" MinWidth="40"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                            <TextBlock Grid.Column="0" Text="Chords1" Foreground="#666" FontSize="10" VerticalAlignment="Center" MinWidth="60"/>
                                            <Slider Grid.Column="1" Value="{Binding Chords1Sensitivity}" Minimum="0" Maximum="3"/>
                                            <TextBlock Grid.Column="2" Text="{Binding Chords1Sensitivity, StringFormat='{}{0:F1}x'}" Foreground="#666" FontSize="10" MinWidth="40"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                            <TextBlock Grid.Column="0" Text="Chords2" Foreground="#666" FontSize="10" VerticalAlignment="Center" MinWidth="60"/>
                                            <Slider Grid.Column="1" Value="{Binding Chords2Sensitivity}" Minimum="0" Maximum="3"/>
                                            <TextBlock Grid.Column="2" Text="{Binding Chords2Sensitivity, StringFormat="{}{0:F1}x'}" Foreground="#666" FontSize="10" MinWidth="40"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                            <TextBlock Grid.Column="0" Text="Melody1" Foreground="#666" FontSize="10" VerticalAlignment="Center" MinWidth="60"/>
                                            <Slider Grid.Column="1" Value="{Binding Melody1Sensitivity}" Minimum="0" Maximum="3"/>
                                            <TextBlock Grid.Column="2" Text="{Binding Melody1Sensitivity, StringFormat='{}{0:F1}x'}" Foreground="#666" FontSize="10" MinWidth="40"/>
                                        </Grid>
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                            <TextBlock Grid.Column="0" Text="Melody2" Foreground="#666" FontSize="10" VerticalAlignment="Center" MinWidth="60"/>
                                            <Slider Grid.Column="1" Value="{Binding Melody2Sensitivity}" Minimum="0" Maximum="3"/>
                                            <TextBlock Grid.Column="2" Text="{Binding Melody2Sensitivity, StringFormat='{}{0:F1}x'}" Foreground="#666" FontSize="10" MinWidth="40"/>
                                        </Grid>
                                    </StackPanel>

                                    <!-- Shader Effect Mappings -->
                                    <StackPanel Spacing="6">
                                        <TextBlock Text="ðŸŽµ Effect Mapping + Intensity" Foreground="#2e3f42" FontWeight="SemiBold" FontSize="11"/>

                                        <!-- Shadow Flicker -->
                                        <Grid ColumnDefinitions="90,*" ColumnSpacing="6" RowDefinitions="Auto,Auto">
                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Shadow" Foreground="#666" FontSize="10" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Row="0" Grid.Column="1" SelectedIndex="{Binding ShadowFlickerSource}" FontSize="10">
                                                <ComboBoxItem Content="None"/>
                                                <ComboBoxItem Content="Drums"/>
                                                <ComboBoxItem Content="Bass"/>
                                                <ComboBoxItem Content="Chords"/>
                                                <ComboBoxItem Content="Melody"/>
                                            </ComboBox>
                                            <Slider Grid.Row="1" Grid.Column="1" Value="{Binding ShadowFlickerIntensity}" Minimum="0" Maximum="100" Margin="0,2,0,0"/>
                                        </Grid>

                                        <!-- Spin -->
                                        <Grid ColumnDefinitions="90,*" ColumnSpacing="6" RowDefinitions="Auto,Auto">
                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Spin" Foreground="#666" FontSize="10" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Row="0" Grid.Column="1" SelectedIndex="{Binding SpinSource}" FontSize="10">
                                                <ComboBoxItem Content="None"/>
                                                <ComboBoxItem Content="Drums"/>
                                                <ComboBoxItem Content="Bass"/>
                                                <ComboBoxItem Content="Chords"/>
                                                <ComboBoxItem Content="Melody"/>
                                            </ComboBox>
                                            <Slider Grid.Row="1" Grid.Column="1" Value="{Binding SpinIntensity}" Minimum="0" Maximum="100" Margin="0,2,0,0"/>
                                        </Grid>

                                        <!-- Beat Pulse -->
                                        <Grid ColumnDefinitions="90,*" ColumnSpacing="6" RowDefinitions="Auto,Auto">
                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Beat Pulse" Foreground="#666" FontSize="10" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Row="0" Grid.Column="1" SelectedIndex="{Binding BeatPulseSource}" FontSize="10">
                                                <ComboBoxItem Content="None"/>
                                                <ComboBoxItem Content="Drums"/>
                                                <ComboBoxItem Content="Bass"/>
                                                <ComboBoxItem Content="Chords"/>
                                                <ComboBoxItem Content="Melody"/>
                                            </ComboBox>
                                            <Slider Grid.Row="1" Grid.Column="1" Value="{Binding BeatPulseIntensity}" Minimum="0" Maximum="100" Margin="0,2,0,0"/>
                                        </Grid>
                                    </StackPanel>
                                </StackPanel>
                            </Expander>

                        </StackPanel>
                    </Border>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>
