<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BalatroSeedOracle.ViewModels.FilterTabs"
             xmlns:i="using:Avalonia.Xaml.Interactivity"
             xmlns:behaviors="using:BalatroSeedOracle.Behaviors"
             xmlns:converters="using:BalatroSeedOracle.Converters"
             xmlns:models="using:BalatroSeedOracle.Models"
             x:Class="BalatroSeedOracle.Components.FilterTabs.ConfigureScoreTab"
             x:DataType="vm:VisualBuilderTabViewModel"
             x:CompileBindings="True">

    <Grid VerticalAlignment="Stretch">
        <Border Name="DragBackdrop"
                Background="#00000066"
                IsVisible="False"
                IsHitTestVisible="False"
                ZIndex="199"/>

        <Grid Margin="16,0,16,16" VerticalAlignment="Stretch">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="200"/>
                <ColumnDefinition Width="1.1*"/>
                <ColumnDefinition Width="1.1*"/>
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0" Margin="0,0,8,0" RowDefinitions="Auto,8,Auto,8,*">
                <Border Grid.Row="0"
                        Background="{StaticResource DarkBackground}"
                        BorderThickness="0"
                        CornerRadius="12"
                        Padding="12,8">
                    <TextBlock Text="{Binding FilterName, FallbackValue='New Filter'}"
                               FontFamily="{StaticResource BalatroFont}"
                               FontSize="14"
                               Foreground="{StaticResource Gold}"
                               HorizontalAlignment="Center"
                               TextTrimming="CharacterEllipsis"/>
                </Border>

                <Border Grid.Row="2"
                        Background="{StaticResource DarkBackground}"
                        BorderThickness="0"
                        CornerRadius="8"
                        Padding="8,4">
                    <TextBox Name="SearchBox"
                             Watermark="Search items..."
                             Text="{Binding SearchFilter, Mode=TwoWay}"
                             Background="Transparent"
                             BorderThickness="0"
                             Foreground="{StaticResource White}"
                             Padding="4"
                             VerticalContentAlignment="Center"
                             FontSize="13">
                        <TextBox.Styles>
                            <Style Selector="TextBox /template/ TextBlock#PART_Watermark">
                                <Setter Property="Foreground" Value="{StaticResource LightGrey}"/>
                            </Style>
                        </TextBox.Styles>
                    </TextBox>
                </Border>

                <StackPanel Grid.Row="4" Spacing="4" Name="CategoryNav" DragDrop.AllowDrop="True">
                    <Button Content="Favorites"
                            Classes="nav-button special"
                            Click="OnCategoryClick"
                            Tag="Favorites"
                            HorizontalAlignment="Stretch"/>
                    <Button Content="Joker"
                            Classes="nav-button"
                            Click="OnCategoryClick"
                            Tag="Joker"
                            HorizontalAlignment="Stretch"/>
                    <Button Content="Consumable"
                            Classes="nav-button"
                            Click="OnCategoryClick"
                            Tag="Consumable"
                            HorizontalAlignment="Stretch"/>
                    <Button Content="Skip Tags"
                            Classes="nav-button"
                            Click="OnCategoryClick"
                            Tag="SkipTag"
                            HorizontalAlignment="Stretch"/>
                    <Button Content="Boss Blind"
                            Classes="nav-button"
                            Click="OnCategoryClick"
                            Tag="Boss"
                            HorizontalAlignment="Stretch"/>
                    <Button Content="Voucher"
                            Classes="nav-button"
                            Click="OnCategoryClick"
                            Tag="Voucher"
                            HorizontalAlignment="Stretch"/>
                    <Button Content="Standard Card"
                            Classes="nav-button"
                            Click="OnCategoryClick"
                            Tag="StandardCard"
                            HorizontalAlignment="Stretch"/>
                </StackPanel>
            </Grid>

            <Grid Grid.Column="1" Margin="8,0">
                <Border Name="ItemGridBorder"
                        Background="{StaticResource DarkBackground}"
                        BorderThickness="0"
                        CornerRadius="12"
                        Padding="12"
                        DragDrop.AllowDrop="True">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="8"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Edition/Sticker/Seal Toolbar - Single horizontal row with sprite icons -->
                        <WrapPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="0,0,0,4">
                            <!-- Edition Buttons -->
                            <Button Command="{Binding SetEditionCommand}"
                                    CommandParameter="None"
                                    Classes="icon-button"
                                    Classes.active="{Binding SelectedEdition, Converter={x:Static converters:StringEqualityConverter.Instance}, ConverterParameter=None}"
                                    ToolTip.Tip="None"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,2,0">
                                <Image Source="{Binding Converter={x:Static converters:EditionSpriteConverter.Instance}, ConverterParameter=None}"
                                       Stretch="Uniform"/>
                            </Button>

                            <Button Command="{Binding SetEditionCommand}"
                                    CommandParameter="Foil"
                                    Classes="icon-button"
                                    Classes.active="{Binding SelectedEdition, Converter={x:Static converters:StringEqualityConverter.Instance}, ConverterParameter=Foil}"
                                    ToolTip.Tip="Foil (+50 chips)"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,2,0">
                                <Image Source="{Binding Converter={x:Static converters:EditionSpriteConverter.Instance}, ConverterParameter=foil}"
                                       Stretch="Uniform"/>
                            </Button>

                            <Button Command="{Binding SetEditionCommand}"
                                    CommandParameter="Holo"
                                    Classes="icon-button"
                                    Classes.active="{Binding SelectedEdition, Converter={x:Static converters:StringEqualityConverter.Instance}, ConverterParameter=Holo}"
                                    ToolTip.Tip="Holographic (+10 mult)"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,2,0">
                                <Image Source="{Binding Converter={x:Static converters:EditionSpriteConverter.Instance}, ConverterParameter=holo}"
                                       Stretch="Uniform"/>
                            </Button>

                            <Button Command="{Binding SetEditionCommand}"
                                    CommandParameter="Polychrome"
                                    Classes="icon-button"
                                    Classes.active="{Binding SelectedEdition, Converter={x:Static converters:StringEqualityConverter.Instance}, ConverterParameter=Polychrome}"
                                    ToolTip.Tip="Polychrome (x1.5 mult)"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,2,0">
                                <Image Source="{Binding Converter={x:Static converters:EditionSpriteConverter.Instance}, ConverterParameter=poly}"
                                       Stretch="Uniform"/>
                            </Button>

                            <Button Command="{Binding SetEditionCommand}"
                                    CommandParameter="Negative"
                                    Classes="icon-button"
                                    Classes.active="{Binding SelectedEdition, Converter={x:Static converters:StringEqualityConverter.Instance}, ConverterParameter=Negative}"
                                    ToolTip.Tip="Negative (+1 joker slot)"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,8,0">
                                <Image Source="{Binding Converter={x:Static converters:EditionSpriteConverter.Instance}, ConverterParameter=negative}"
                                       Stretch="Uniform"/>
                            </Button>

                            <!-- Sticker Buttons -->
                            <Button Command="{Binding ToggleStickerPerishableCommand}"
                                    Classes="icon-button"
                                    Classes.active="{Binding StickerPerishable}"
                                    ToolTip.Tip="Perishable"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,2,0">
                                <Image Source="{Binding Converter={x:Static converters:StickerSpriteConverter.Instance}, ConverterParameter=perishable}"
                                       Stretch="Uniform"/>
                            </Button>

                            <Button Command="{Binding ToggleStickerEternalCommand}"
                                    Classes="icon-button"
                                    Classes.active="{Binding StickerEternal}"
                                    ToolTip.Tip="Eternal"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,2,0">
                                <Image Source="{Binding Converter={x:Static converters:StickerSpriteConverter.Instance}, ConverterParameter=eternal}"
                                       Stretch="Uniform"/>
                            </Button>

                            <Button Command="{Binding ToggleStickerRentalCommand}"
                                    Classes="icon-button"
                                    Classes.active="{Binding StickerRental}"
                                    ToolTip.Tip="Rental"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,8,0">
                                <Image Source="{Binding Converter={x:Static converters:StickerSpriteConverter.Instance}, ConverterParameter=rental}"
                                       Stretch="Uniform"/>
                            </Button>

                            <!-- Seal Buttons (StandardCard only) -->
                            <Button Command="{Binding SetSealCommand}"
                                    CommandParameter="None"
                                    Classes="icon-button"
                                    Classes.active="{Binding SelectedSeal, Converter={x:Static converters:StringEqualityConverter.Instance}, ConverterParameter=None}"
                                    ToolTip.Tip="No Seal"
                                    Width="32" Height="32"
                                    Padding="4"
                                    Margin="0,0,2,0">
                                <TextBlock Text="—" FontSize="16" Foreground="{StaticResource LightGrey}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Button>

                            <Button Command="{Binding SetSealCommand}"
                                    CommandParameter="Purple"
                                    Classes="icon-button"
                                    Classes.active="{Binding SelectedSeal, Converter={x:Static converters:StringEqualityConverter.Instance}, ConverterParameter=Purple}"
                                    ToolTip.Tip="Purple Seal"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,2,0">
                                <Image Source="{Binding Converter={x:Static converters:SealSpriteConverter.Instance}, ConverterParameter=purple}"
                                       Stretch="Uniform"/>
                            </Button>

                            <Button Command="{Binding SetSealCommand}"
                                    CommandParameter="Gold"
                                    Classes="icon-button"
                                    Classes.active="{Binding SelectedSeal, Converter={x:Static converters:StringEqualityConverter.Instance}, ConverterParameter=Gold}"
                                    ToolTip.Tip="Gold Seal"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,2,0">
                                <Image Source="{Binding Converter={x:Static converters:SealSpriteConverter.Instance}, ConverterParameter=gold}"
                                       Stretch="Uniform"/>
                            </Button>

                            <Button Command="{Binding SetSealCommand}"
                                    CommandParameter="Red"
                                    Classes="icon-button"
                                    Classes.active="{Binding SelectedSeal, Converter={x:Static converters:StringEqualityConverter.Instance}, ConverterParameter=Red}"
                                    ToolTip.Tip="Red Seal"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,2,0">
                                <Image Source="{Binding Converter={x:Static converters:SealSpriteConverter.Instance}, ConverterParameter=red}"
                                       Stretch="Uniform"/>
                            </Button>

                            <Button Command="{Binding SetSealCommand}"
                                    CommandParameter="Blue"
                                    Classes="icon-button"
                                    Classes.active="{Binding SelectedSeal, Converter={x:Static converters:StringEqualityConverter.Instance}, ConverterParameter=Blue}"
                                    ToolTip.Tip="Blue Seal"
                                    Width="32" Height="32"
                                    Padding="2"
                                    Margin="0,0,0,0">
                                <Image Source="{Binding Converter={x:Static converters:SealSpriteConverter.Instance}, ConverterParameter=blue}"
                                       Stretch="Uniform"/>
                            </Button>
                        </WrapPanel>

                        <!-- Item Shelf ScrollViewer -->
                        <ScrollViewer Grid.Row="2"
                                      Name="ItemScrollViewer"
                                      VerticalScrollBarVisibility="Auto"
                                      HorizontalScrollBarVisibility="Disabled">
                        <ItemsControl ItemsSource="{Binding GroupedItems}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="vm:VisualBuilderTabViewModel+ItemGroup">
                                    <StackPanel Margin="0,0,0,16">
                                        <Border Background="{StaticResource DarkBackground}"
                                                BorderThickness="0"
                                                Padding="8,6"
                                                Margin="0,0,0,4"
                                                CornerRadius="4">
                                            <TextBlock Text="{Binding GroupName}"
                                                       FontFamily="{StaticResource BalatroFont}"
                                                       FontSize="16"
                                                       FontWeight="Normal"
                                                       Foreground="{StaticResource LightGrey}"
                                                       TextAlignment="Left"/>
                                        </Border>

                                        <ItemsControl ItemsSource="{Binding Items}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="models:FilterItem">
                                                    <Grid Margin="0,2" Width="54" Height="78">
                                                        <i:Interaction.Behaviors>
                                                            <behaviors:CardDragBehavior IsEnabled="True" JuiceAmount="0.4"/>
                                                        </i:Interaction.Behaviors>
                                                        <Border Background="Transparent"
                                                                Opacity="{Binding IsBeingDragged, Converter={x:Static converters:BoolToOpacityConverter.Dragging}}"
                                                                Cursor="Hand"
                                                                ZIndex="0"
                                                                ClipToBounds="True"
                                                                IsHitTestVisible="False">
                                                            <StackPanel Spacing="2">
                                                                <Grid Width="48" Height="64">
                                                                    <Image Source="{Binding ItemImage}"
                                                                           Width="48"
                                                                           Height="64"
                                                                           Stretch="Uniform"
                                                                           HorizontalAlignment="Center"
                                                                           VerticalAlignment="Center">
                                                                        <i:Interaction.Behaviors>
                                                                            <behaviors:CardFlipOnTriggerBehavior
                                                                                DeckName="Red"
                                                                                FlipTrigger="{Binding $parent[UserControl].((vm:VisualBuilderTabViewModel)DataContext).FlipAnimationTrigger}"
                                                                                StaggerDelay="{Binding StaggerDelay}"/>
                                                                        </i:Interaction.Behaviors>
                                                                    </Image>

                                                                    <Image Source="{Binding SoulFaceImage}"
                                                                           Width="48"
                                                                           Height="64"
                                                                           Stretch="Uniform"
                                                                           HorizontalAlignment="Center"
                                                                           VerticalAlignment="Center"
                                                                           IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                                                </Grid>

                                                                <TextBlock Text="{Binding DisplayName}"
                                                                           Foreground="#FFFFFF"
                                                                           FontFamily="{StaticResource BalatroFont}"
                                                                           FontSize="8"
                                                                           HorizontalAlignment="Center"
                                                                           TextAlignment="Center"
                                                                           TextWrapping="Wrap"
                                                                           MaxWidth="54"/>
                                                            </StackPanel>
                                                        </Border>

                                                        <Border ZIndex="1"
                                                                Background="Transparent"
                                                                Cursor="Hand"
                                                                IsHitTestVisible="True"
                                                                PointerPressed="OnItemPointerPressed"
                                                                PointerEntered="OnCardPointerEntered"
                                                                Width="54"
                                                                Height="78"/>
                                                    </Grid>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                        </ItemsControl>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                    </Grid>
                </Border>
            </Grid>

            <Grid Grid.Column="2" Margin="8,0,0,0">
                <Border Background="{StaticResource DarkBackground}"
                        BorderThickness="0"
                        CornerRadius="12"
                        Padding="12"
                        Name="ScoreListDropZone"
                        DragDrop.AllowDrop="True">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0"
                                   Text="SCORE COLUMNS"
                                   FontFamily="{StaticResource BalatroFont}"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="{StaticResource Green}"
                                   HorizontalAlignment="Center"
                                   Margin="0,0,0,8"/>

                        <TextBlock Grid.Row="1"
                                   Text="Each item adds a column to results"
                                   FontFamily="{StaticResource BalatroFont}"
                                   FontSize="12"
                                   Foreground="{StaticResource LightGrey}"
                                   HorizontalAlignment="Center"
                                   TextAlignment="Center"
                                   Margin="0,0,0,12"/>

                        <!-- Operator Trays (VERTICAL STACK) -->
                        <StackPanel Grid.Row="2" Spacing="8" Margin="0,0,0,12">
                            <!-- OR Tray Wrapper (with overlay) -->
                            <Grid IsVisible="{Binding !ShouldHideOrTray}">
                                <Border Name="OrTray"
                                        Background="{StaticResource DarkBackground}"
                                        BorderBrush="{StaticResource Green}"
                                        BorderThickness="2,0,0,0"
                                        CornerRadius="6"
                                        Padding="8"
                                        MinHeight="80"
                                        DragDrop.AllowDrop="True">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- OR Label -->
                                    <TextBlock Grid.Row="0"
                                               Text="OR CLAUSE"
                                               FontFamily="{StaticResource BalatroFont}"
                                               FontSize="14"
                                               FontWeight="Bold"
                                               Foreground="{StaticResource Green}"
                                               HorizontalAlignment="Left"
                                               VerticalAlignment="Center"
                                               Margin="0,0,0,4"/>

                                    <!-- OR Cards Container -->
                                    <ScrollViewer Grid.Row="1"
                                                  VerticalScrollBarVisibility="Auto"
                                                  HorizontalScrollBarVisibility="Disabled">
                                        <ItemsControl ItemsSource="{Binding OrTrayItems}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="models:FilterItem">
                                                    <Border Margin="0,2" Padding="4" Background="{StaticResource ModalGrey}" CornerRadius="4">
                                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                                            <Grid Grid.Column="0" Width="24" Height="32" Margin="0,0,6,0">
                                                                <Image Source="{Binding ItemImage}"
                                                                       Width="24"
                                                                       Height="32"
                                                                       Stretch="Uniform"/>
                                                                <Image Source="{Binding SoulFaceImage}"
                                                                       Width="24"
                                                                       Height="32"
                                                                       Stretch="Uniform"
                                                                       IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                                            </Grid>

                                                            <TextBlock Grid.Column="1"
                                                                       Text="{Binding DisplayName}"
                                                                       FontFamily="{StaticResource BalatroFont}"
                                                                       FontSize="11"
                                                                       Foreground="{StaticResource White}"
                                                                       VerticalAlignment="Center"
                                                                       TextTrimming="CharacterEllipsis"/>

                                                            <Button Grid.Column="2"
                                                                    Content="×"
                                                                    Command="{Binding $parent[UserControl].DataContext.RemoveFromOrTrayCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    Background="{StaticResource Red}"
                                                                    Foreground="White"
                                                                    FontSize="12"
                                                                    Width="20"
                                                                    Height="20"
                                                                    CornerRadius="10"
                                                                    Padding="0"
                                                                    Margin="4,0,0,0"
                                                                    HorizontalContentAlignment="Center"
                                                                    VerticalContentAlignment="Center"/>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>

                                    <!-- Footer bar with Done button -->
                                    <Border Grid.Row="2"
                                            Background="{StaticResource Blue}"
                                            Padding="8"
                                            Margin="0,8,0,0"
                                            CornerRadius="4">
                                        <Button Content="Done ✓"
                                                Command="{Binding CommitOrClauseCommand}"
                                                HorizontalAlignment="Stretch"
                                                Background="{StaticResource Blue}"
                                                Foreground="{StaticResource White}"
                                                FontFamily="{StaticResource BalatroFont}"
                                                FontSize="13"
                                                FontWeight="Bold"
                                                Padding="0,6"
                                                CornerRadius="4"
                                                Classes="pill-button"/>
                                    </Border>
                                </Grid>
                            </Border>

                            <!-- OR Tray Drop Overlay -->
                            <Border Name="OrTrayDropOverlay"
                                    Background="{StaticResource Green}"
                                    BorderBrush="#FFFFFF"
                                    BorderThickness="3"
                                    CornerRadius="6"
                                    IsVisible="False"
                                    IsHitTestVisible="False"
                                    ZIndex="200"
                                    Opacity="0.9">
                                <Border.Styles>
                                    <Style Selector="Border[IsVisible=True]">
                                        <Style.Animations>
                                            <Animation Duration="0:0:0.8" IterationCount="Infinite">
                                                <KeyFrame Cue="0%">
                                                    <Setter Property="BoxShadow" Value="0 0 0 0 #FFFFFF"/>
                                                    <Setter Property="Background" Value="{StaticResource Green}"/>
                                                </KeyFrame>
                                                <KeyFrame Cue="50%">
                                                    <Setter Property="BoxShadow" Value="0 0 0 3 #FFFFFF"/>
                                                    <Setter Property="Background" Value="{StaticResource GreenHover}"/>
                                                </KeyFrame>
                                                <KeyFrame Cue="100%">
                                                    <Setter Property="BoxShadow" Value="0 0 0 0 #FFFFFF"/>
                                                    <Setter Property="Background" Value="{StaticResource Green}"/>
                                                </KeyFrame>
                                            </Animation>
                                        </Style.Animations>
                                    </Style>
                                </Border.Styles>
                                <TextBlock Text="OR CLAUSE"
                                           FontFamily="{StaticResource BalatroFont}"
                                           FontSize="18"
                                           FontWeight="Bold"
                                           Foreground="{StaticResource White}"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Border>
                        </Grid>

                            <!-- AND Tray Wrapper (with overlay) -->
                            <Grid IsVisible="{Binding !ShouldHideAndTray}">
                                <Border Name="AndTray"
                                        Background="{StaticResource DarkBackground}"
                                        BorderBrush="{StaticResource Blue}"
                                        BorderThickness="2,0,0,0"
                                        CornerRadius="6"
                                        Padding="8"
                                        MinHeight="80"
                                        DragDrop.AllowDrop="True">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- AND Label -->
                                    <TextBlock Grid.Row="0"
                                               Text="AND CLAUSE"
                                               FontFamily="{StaticResource BalatroFont}"
                                               FontSize="14"
                                               FontWeight="Bold"
                                               Foreground="{StaticResource Blue}"
                                               HorizontalAlignment="Left"
                                               VerticalAlignment="Center"
                                               Margin="0,0,0,4"/>

                                    <!-- AND Cards Container -->
                                    <ScrollViewer Grid.Row="1"
                                                  VerticalScrollBarVisibility="Auto"
                                                  HorizontalScrollBarVisibility="Disabled">
                                        <ItemsControl ItemsSource="{Binding AndTrayItems}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="models:FilterItem">
                                                    <Border Margin="0,2" Padding="4" Background="{StaticResource ModalGrey}" CornerRadius="4">
                                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                                            <Grid Grid.Column="0" Width="24" Height="32" Margin="0,0,6,0">
                                                                <Image Source="{Binding ItemImage}"
                                                                       Width="24"
                                                                       Height="32"
                                                                       Stretch="Uniform"/>
                                                                <Image Source="{Binding SoulFaceImage}"
                                                                       Width="24"
                                                                       Height="32"
                                                                       Stretch="Uniform"
                                                                       IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                                            </Grid>

                                                            <TextBlock Grid.Column="1"
                                                                       Text="{Binding DisplayName}"
                                                                       FontFamily="{StaticResource BalatroFont}"
                                                                       FontSize="11"
                                                                       Foreground="{StaticResource White}"
                                                                       VerticalAlignment="Center"
                                                                       TextTrimming="CharacterEllipsis"/>

                                                            <Button Grid.Column="2"
                                                                    Content="×"
                                                                    Command="{Binding $parent[UserControl].DataContext.RemoveFromAndTrayCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    Background="{StaticResource Red}"
                                                                    Foreground="White"
                                                                    FontSize="12"
                                                                    Width="20"
                                                                    Height="20"
                                                                    CornerRadius="10"
                                                                    Padding="0"
                                                                    Margin="4,0,0,0"
                                                                    HorizontalContentAlignment="Center"
                                                                    VerticalContentAlignment="Center"/>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>

                                    <!-- Footer bar with Done button -->
                                    <Border Grid.Row="2"
                                            Background="{StaticResource Blue}"
                                            Padding="8"
                                            Margin="0,8,0,0"
                                            CornerRadius="4">
                                        <Button Content="Done ✓"
                                                Command="{Binding CommitAndClauseCommand}"
                                                HorizontalAlignment="Stretch"
                                                Background="{StaticResource Blue}"
                                                Foreground="{StaticResource White}"
                                                FontFamily="{StaticResource BalatroFont}"
                                                FontSize="13"
                                                FontWeight="Bold"
                                                Padding="0,6"
                                                CornerRadius="4"
                                                Classes="pill-button"/>
                                    </Border>
                                </Grid>
                            </Border>

                            <!-- AND Tray Drop Overlay -->
                            <Border Name="AndTrayDropOverlay"
                                    Background="{StaticResource Blue}"
                                    BorderBrush="#FFFFFF"
                                    BorderThickness="3"
                                    CornerRadius="6"
                                    IsVisible="False"
                                    IsHitTestVisible="False"
                                    ZIndex="200"
                                    Opacity="0.9">
                                <Border.Styles>
                                    <Style Selector="Border[IsVisible=True]">
                                        <Style.Animations>
                                            <Animation Duration="0:0:0.8" IterationCount="Infinite">
                                                <KeyFrame Cue="0%">
                                                    <Setter Property="BoxShadow" Value="0 0 0 0 #FFFFFF"/>
                                                    <Setter Property="Background" Value="{StaticResource Blue}"/>
                                                </KeyFrame>
                                                <KeyFrame Cue="50%">
                                                    <Setter Property="BoxShadow" Value="0 0 0 3 #FFFFFF"/>
                                                    <Setter Property="Background" Value="{StaticResource BlueHover}"/>
                                                </KeyFrame>
                                                <KeyFrame Cue="100%">
                                                    <Setter Property="BoxShadow" Value="0 0 0 0 #FFFFFF"/>
                                                    <Setter Property="Background" Value="{StaticResource Blue}"/>
                                                </KeyFrame>
                                            </Animation>
                                        </Style.Animations>
                                    </Style>
                                </Border.Styles>
                                <TextBlock Text="AND CLAUSE"
                                           FontFamily="{StaticResource BalatroFont}"
                                           FontSize="18"
                                           FontWeight="Bold"
                                           Foreground="{StaticResource White}"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                        </StackPanel>

                        <!-- Separator -->
                        <Border Grid.Row="3"
                                Height="2"
                                Background="{StaticResource ModalBorder}"
                                Margin="0,0,0,12"
                                CornerRadius="1"
                                IsVisible="{Binding !ShouldHideShouldZone}"/>

                        <!-- Score List Wrapper (with overlay) -->
                        <Grid Grid.Row="4" IsVisible="{Binding !ShouldHideShouldZone}">
                            <ScrollViewer VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Disabled">
                            <ItemsControl ItemsSource="{Binding SelectedShould}">
                                <ItemsControl.DataTemplates>
                                    <!-- Template for FilterOperatorItem (OR/AND clauses with children) -->
                                    <DataTemplate DataType="models:FilterOperatorItem">
                                        <Expander Margin="0,0,0,8"
                                                  HorizontalAlignment="Stretch">
                                            <Expander.Header>
                                                <Grid ColumnDefinitions="Auto,*,Auto" Margin="4">
                                                    <!-- Operator Type Badge -->
                                                    <Border Grid.Column="0"
                                                            Background="{StaticResource Green}"
                                                            BorderThickness="2"
                                                            BorderBrush="{StaticResource Green}"
                                                            CornerRadius="4"
                                                            Padding="12,8"
                                                            Margin="0,0,12,0">
                                                        <TextBlock Text="{Binding OperatorType}"
                                                                   FontFamily="{StaticResource BalatroFont}"
                                                                   FontSize="14"
                                                                   FontWeight="Bold"
                                                                   Foreground="{StaticResource White}"/>
                                                    </Border>

                                                    <!-- Clause description -->
                                                    <TextBlock Grid.Column="1"
                                                               Text="{Binding DisplayName}"
                                                               FontFamily="{StaticResource BalatroFont}"
                                                               FontSize="14"
                                                               Foreground="{StaticResource White}"
                                                               VerticalAlignment="Center"/>

                                                    <!-- Remove button -->
                                                    <Button Grid.Column="2"
                                                            Content="×"
                                                            Command="{Binding $parent[UserControl].DataContext.RemoveFromShouldCommand}"
                                                            CommandParameter="{Binding}"
                                                            Background="{StaticResource Red}"
                                                            Foreground="White"
                                                            FontSize="16"
                                                            FontWeight="Bold"
                                                            Width="28"
                                                            Height="28"
                                                            CornerRadius="14"
                                                            Padding="0"
                                                            HorizontalContentAlignment="Center"
                                                            VerticalContentAlignment="Center"/>
                                                </Grid>
                                            </Expander.Header>

                                            <!-- Expanded: Show children -->
                                            <Border Background="{StaticResource ModalGrey}"
                                                    BorderThickness="2,0,0,0"
                                                    BorderBrush="{StaticResource Green}"
                                                    Padding="12"
                                                    Margin="4,0,4,4">
                                                <ItemsControl ItemsSource="{Binding Children}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate DataType="models:FilterItem">
                                                            <Border Margin="0,2" Padding="4" Background="{StaticResource DarkBackground}" CornerRadius="4">
                                                                <Grid ColumnDefinitions="Auto,*">
                                                                    <Grid Grid.Column="0" Width="24" Height="32" Margin="0,0,6,0">
                                                                        <Image Source="{Binding ItemImage}"
                                                                               Width="24"
                                                                               Height="32"
                                                                               Stretch="Uniform"/>
                                                                    </Grid>
                                                                    <TextBlock Grid.Column="1"
                                                                               Text="{Binding DisplayName}"
                                                                               FontFamily="{StaticResource BalatroFont}"
                                                                               FontSize="11"
                                                                               Foreground="{StaticResource White}"
                                                                               VerticalAlignment="Center"/>
                                                                </Grid>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </Border>
                                        </Expander>
                                    </DataTemplate>

                                    <!-- Template for regular FilterItem (jokers, cards, etc) -->
                                    <DataTemplate DataType="models:FilterItem">
                                        <Expander Margin="0,0,0,8"
                                                  HorizontalAlignment="Stretch">
                                            <Expander.Header>
                                                <Grid ColumnDefinitions="Auto,*,Auto,Auto" Margin="4">
                                                    <Grid Grid.Column="0" Width="32" Height="44" Margin="0,0,8,0">
                                                        <Image Source="{Binding ItemImage}"
                                                               Width="32"
                                                               Height="44"
                                                               Stretch="Uniform"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"/>

                                                        <Image Source="{Binding SoulFaceImage}"
                                                               Width="32"
                                                               Height="44"
                                                               Stretch="Uniform"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"
                                                               IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                                    </Grid>

                                                    <TextBlock Grid.Column="1"
                                                               Text="{Binding DisplayName}"
                                                               FontFamily="{StaticResource BalatroFont}"
                                                               FontSize="14"
                                                               Foreground="{StaticResource White}"
                                                               VerticalAlignment="Center"
                                                               TextWrapping="Wrap"
                                                               Margin="0,0,8,0"/>

                                                    <Border Grid.Column="2"
                                                            Background="{StaticResource DarkBackground}"
                                                            BorderThickness="0"
                                                            CornerRadius="4"
                                                            Padding="8,4"
                                                            Margin="0,0,8,0">
                                                        <TextBlock FontFamily="{StaticResource BalatroFont}"
                                                                   FontSize="11"
                                                                   Foreground="{StaticResource LightGrey}"
                                                                   VerticalAlignment="Center">
                                                            <Run Text="Weight: "/>
                                                            <Run Text="{Binding Value, FallbackValue=10}"/>
                                                        </TextBlock>
                                                    </Border>

                                                    <Button Grid.Column="3"
                                                            Content="×"
                                                            Command="{Binding $parent[UserControl].DataContext.RemoveFromShouldCommand}"
                                                            CommandParameter="{Binding}"
                                                            Background="{StaticResource Red}"
                                                            Foreground="White"
                                                            FontSize="16"
                                                            FontWeight="Bold"
                                                            Width="28"
                                                            Height="28"
                                                            CornerRadius="14"
                                                            Padding="0"
                                                            HorizontalContentAlignment="Center"
                                                            VerticalContentAlignment="Center">
                                                        <Button.Styles>
                                                            <Style Selector="Button:pointerover">
                                                                <Setter Property="Background" Value="{StaticResource RedHover}"/>
                                                            </Style>
                                                        </Button.Styles>
                                                    </Button>
                                                </Grid>
                                            </Expander.Header>

                                            <Border Background="{StaticResource ModalGrey}"
                                                    BorderThickness="0"
                                                    CornerRadius="4"
                                                    Padding="12"
                                                    Margin="4,0,4,4">
                                                <StackPanel Spacing="8">
                                                    <TextBox Watermark="Label (optional)"
                                                             Text="{Binding Label, Mode=TwoWay}"
                                                             Background="{StaticResource DarkBackground}"
                                                             Foreground="{StaticResource White}"
                                                             BorderThickness="0"
                                                             CornerRadius="4"
                                                             Padding="8,6"
                                                             FontFamily="{StaticResource BalatroFont}"
                                                             FontSize="12"/>

                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="Weight"
                                                                   FontFamily="{StaticResource BalatroFont}"
                                                                   FontSize="12"
                                                                   Foreground="{StaticResource LightGrey}"/>
                                                        <Slider Minimum="1"
                                                                Maximum="100"
                                                                Value="{Binding Value, Mode=TwoWay, FallbackValue=10}"
                                                                TickFrequency="1"
                                                                IsSnapToTickEnabled="True"/>
                                                    </StackPanel>

                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="Antes (optional)"
                                                                   FontFamily="{StaticResource BalatroFont}"
                                                                   FontSize="12"
                                                                   Foreground="{StaticResource LightGrey}"/>
                                                        <TextBlock Text="Select specific antes to match"
                                                                   FontFamily="{StaticResource BalatroFont}"
                                                                   FontSize="10"
                                                                   Foreground="{StaticResource LightGrey}"
                                                                   Opacity="0.7"
                                                                   Margin="0,0,0,4"/>
                                                        <WrapPanel>
                                                            <CheckBox Content="1" Margin="4,2"/>
                                                            <CheckBox Content="2" Margin="4,2"/>
                                                            <CheckBox Content="3" Margin="4,2"/>
                                                            <CheckBox Content="4" Margin="4,2"/>
                                                            <CheckBox Content="5" Margin="4,2"/>
                                                            <CheckBox Content="6" Margin="4,2"/>
                                                            <CheckBox Content="7" Margin="4,2"/>
                                                            <CheckBox Content="8" Margin="4,2"/>
                                                        </WrapPanel>
                                                    </StackPanel>

                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="Edition"
                                                                   FontFamily="{StaticResource BalatroFont}"
                                                                   FontSize="12"
                                                                   Foreground="{StaticResource LightGrey}"/>
                                                        <WrapPanel>
                                                            <RadioButton Content="None" Margin="4,2" IsChecked="True"/>
                                                            <RadioButton Content="Foil" Margin="4,2"/>
                                                            <RadioButton Content="Holo" Margin="4,2"/>
                                                            <RadioButton Content="Poly" Margin="4,2"/>
                                                            <RadioButton Content="Negative" Margin="4,2"/>
                                                        </WrapPanel>
                                                    </StackPanel>

                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="Source"
                                                                   FontFamily="{StaticResource BalatroFont}"
                                                                   FontSize="12"
                                                                   Foreground="{StaticResource LightGrey}"/>
                                                        <WrapPanel>
                                                            <CheckBox Content="Booster" IsChecked="{Binding IncludeBoosterPacks, Mode=TwoWay}" Margin="4,2"/>
                                                            <CheckBox Content="Shop" IsChecked="{Binding IncludeShopStream, Mode=TwoWay}" Margin="4,2"/>
                                                            <CheckBox Content="Skip Tags" IsChecked="{Binding IncludeSkipTags, Mode=TwoWay}" Margin="4,2"/>
                                                        </WrapPanel>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>
                                        </Expander>
                                    </DataTemplate>
                                </ItemsControl.DataTemplates>
                            </ItemsControl>
                        </ScrollViewer>

                        <!-- Score List Drop Overlay -->
                        <Border Name="ScoreListDropOverlay"
                                Background="{StaticResource Green}"
                                BorderBrush="#FFFFFF"
                                BorderThickness="3"
                                CornerRadius="12"
                                IsVisible="False"
                                IsHitTestVisible="False"
                                ZIndex="200"
                                Opacity="0.9">
                            <Border.Styles>
                                <Style Selector="Border[IsVisible=True]">
                                    <Style.Animations>
                                        <Animation Duration="0:0:0.8" IterationCount="Infinite">
                                            <KeyFrame Cue="0%">
                                                <Setter Property="BoxShadow" Value="0 0 0 0 #FFFFFF"/>
                                                <Setter Property="Background" Value="{StaticResource Green}"/>
                                            </KeyFrame>
                                            <KeyFrame Cue="50%">
                                                <Setter Property="BoxShadow" Value="0 0 0 3 #FFFFFF"/>
                                                <Setter Property="Background" Value="{StaticResource GreenHover}"/>
                                            </KeyFrame>
                                            <KeyFrame Cue="100%">
                                                <Setter Property="BoxShadow" Value="0 0 0 0 #FFFFFF"/>
                                                <Setter Property="Background" Value="{StaticResource Green}"/>
                                            </KeyFrame>
                                        </Animation>
                                    </Style.Animations>
                                </Style>
                            </Border.Styles>
                            <TextBlock Text="ADD TO SCORE COLUMNS"
                                       FontFamily="{StaticResource BalatroFont}"
                                       FontSize="24"
                                       FontWeight="ExtraBold"
                                       Foreground="{StaticResource White}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       TextAlignment="Center">
                                <TextBlock.Effect>
                                    <DropShadowEffect Color="#000000" BlurRadius="12" OffsetX="3" OffsetY="3" Opacity="1"/>
                                </TextBlock.Effect>
                            </TextBlock>
                        </Border>
                    </Grid>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
