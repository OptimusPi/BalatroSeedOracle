<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BalatroSeedOracle.ViewModels.FilterTabs"
             xmlns:i="using:Avalonia.Xaml.Interactivity"
             xmlns:behaviors="using:BalatroSeedOracle.Behaviors"
             xmlns:converters="using:BalatroSeedOracle.Converters"
             x:Class="BalatroSeedOracle.Components.FilterTabs.VisualBuilderTab">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="200"/>   <!-- Left: Category Buttons (Red Sidebar) -->
            <ColumnDefinition Width="*"/>     <!-- Center: Item Grid -->
            <ColumnDefinition Width="300"/>   <!-- Right: Drop Zones -->
        </Grid.ColumnDefinitions>
        
        <!-- LEFT: Clean Category Buttons (Flat Balatro style) -->
        <StackPanel Grid.Column="0" Spacing="1" Margin="0,0,8,0">
            <Button Content="🔥 Faves" Classes="nav-button" Click="OnCategoryClick" Tag="Favorites"/>
            <Button Content="🏆 Legendary" Classes="nav-button" Click="OnCategoryClick" Tag="Legendary"/>
            <Button Content="💎 Rare" Classes="nav-button" Click="OnCategoryClick" Tag="Rare"/>
            <Button Content="🔸 Uncommon" Classes="nav-button" Click="OnCategoryClick" Tag="Uncommon"/>
            <Button Content="⚪ Common" Classes="nav-button" Click="OnCategoryClick" Tag="Common"/>
            <Button Content="🎟️ Voucher" Classes="nav-button" Click="OnCategoryClick" Tag="Voucher"/>
            <Button Content="🔮 Tarot" Classes="nav-button" Click="OnCategoryClick" Tag="Tarot"/>
            <Button Content="🪐 Planet" Classes="nav-button" Click="OnCategoryClick" Tag="Planet"/>
            <Button Content="👻 Spectral" Classes="nav-button" Click="OnCategoryClick" Tag="Spectral"/>
            <Button Content="🃏 Playing Cards" Classes="nav-button" Click="OnCategoryClick" Tag="PlayingCards"/>
            <Button Content="🏷️ Tag" Classes="nav-button" Click="OnCategoryClick" Tag="Tag"/>
            <Button Content="👹 Boss" Classes="nav-button" Click="OnCategoryClick" Tag="Boss"/>
            <Button Content="🗑️ Clear ALL" Classes="nav-button" Click="OnClearAll" Background="{StaticResource Orange}"/>
        </StackPanel>
        
        <!-- CENTER: Clean Item Grid (No borders, flat style) -->
        <Grid Grid.Column="1" Margin="8,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>  <!-- Category Title + Search -->
                <RowDefinition Height="16"/>    <!-- Spacer -->
                <RowDefinition Height="*"/>     <!-- Item Grid -->
            </Grid.RowDefinitions>
            
            <!-- Header: Search only -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Left">
                <TextBox Text="{Binding SearchFilter}"
                         Watermark="Search items..."
                         Width="200"
                         Height="32"
                         BorderThickness="0"
                         Background="#2a2a2a"/>
                <Button Content="×"
                        ToolTip.Tip="Clear search"
                        Click="OnClearSearch"
                        Width="32" Height="32"
                        Background="{StaticResource Orange}"
                        BorderThickness="0"/>
            </StackPanel>
            
            <!-- Item Cards Grid - Clean and flat -->
            <ScrollViewer Grid.Row="2" 
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Background="Transparent">
                <ItemsControl ItemsSource="{Binding FilteredItems}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="8"
                                       Cursor="Hand"
                                       PointerPressed="OnItemPointerPressed"
                                       Opacity="{Binding IsBeingDragged, Converter={x:Static converters:BoolToOpacityConverter.Dragging}}">
                                <!-- CardDragBehavior REMOVED - only needed on drag ghost, not source items -->
                                <Grid>
                                    <!-- Main card image -->
                                    <Image Source="{Binding ItemImage}"
                                           Width="71"
                                           Height="95"
                                           Stretch="Uniform"
                                           HorizontalAlignment="Center"/>

                                    <!-- Legendary soul face overlay (only for SoulJoker type) -->
                                    <Image Source="{Binding SoulFaceImage}"
                                           Width="71"
                                           Height="95"
                                           Stretch="Uniform"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                </Grid>
                                
                                <!-- Simple name below -->
                                <TextBlock Text="{Binding DisplayName}" 
                                           Foreground="{StaticResource White}"
                                           FontFamily="{StaticResource BalatroFont}"
                                           FontSize="10"
                                           HorizontalAlignment="Center"
                                           TextAlignment="Center"
                                           TextTrimming="CharacterEllipsis"
                                           Margin="0,4,0,0"
                                           MaxWidth="80"/>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </ScrollViewer>
        </Grid>
        
        <!-- RIGHT: Drop Zones exactly like your screenshot -->
        <Border Grid.Column="2"
                Background="{StaticResource ContainerDarkPrecise}"
                BorderThickness="2"
                BorderBrush="{StaticResource ModalBorder}"
                CornerRadius="8"
                Padding="15">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Spacing="15">
                    <!-- MUST HAVE Zone -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="MUST HAVE"
                                   FontFamily="{StaticResource BalatroFont}"
                                   FontSize="14"
                                   FontWeight="Bold"
                                   Foreground="{StaticResource Green}"
                                   HorizontalAlignment="Left"/>
                        <Border Name="MustDropZone"
                                Background="{StaticResource DarkBackground}"
                                BorderBrush="{StaticResource Green}"
                                BorderThickness="2"
                                CornerRadius="8"
                                MinHeight="120"
                                Padding="8"
                                Margin="0"
                                DragDrop.AllowDrop="True">
                            <ItemsControl ItemsSource="{Binding SelectedMust}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="4" Width="71" Height="95" Cursor="Hand" DoubleTapped="OnItemDoubleTapped">
                                            <!-- Main card image (NO BORDER!) -->
                                            <Image Source="{Binding ItemImage}"
                                                   Width="71"
                                                   Height="95"
                                                   Stretch="Uniform"/>

                                            <!-- Soul face overlay for legendary jokers -->
                                            <Image Source="{Binding SoulFaceImage}"
                                                   Width="71"
                                                   Height="95"
                                                   Stretch="Uniform"
                                                   IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                            
                                            <!-- Hover-only Remove Button -->
                                            <Button Content="×" 
                                                    Command="{Binding $parent[UserControl].DataContext.RemoveFromMustCommand}"
                                                    CommandParameter="{Binding}"
                                                    Background="{StaticResource Red}"
                                                    Foreground="White"
                                                    FontSize="12"
                                                    FontWeight="Bold"
                                                    Width="18"
                                                    Height="18"
                                                    CornerRadius="9"
                                                    Padding="0"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"
                                                    Margin="0,-6,-6,0"
                                                    IsVisible="False"
                                                    Name="RemoveButton">
                                                <Button.Styles>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="{StaticResource RedHover}"/>
                                                    </Style>
                                                </Button.Styles>
                                            </Button>
                                            
                                            <Grid.Styles>
                                                <Style Selector="Grid:pointerover Button#RemoveButton">
                                                    <Setter Property="IsVisible" Value="True"/>
                                                </Style>
                                            </Grid.Styles>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </Border>
                    </StackPanel>

                    <!-- SHOULD HAVE Zone -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="SHOULD HAVE"
                                   FontFamily="{StaticResource BalatroFont}"
                                   FontSize="14"
                                   FontWeight="Bold"
                                   Foreground="{StaticResource Blue}"
                                   HorizontalAlignment="Left"/>
                        <Border Name="ShouldDropZone"
                                Background="{StaticResource DarkBackground}"
                                BorderBrush="{StaticResource Blue}"
                                BorderThickness="2"
                                CornerRadius="8"
                                MinHeight="120"
                                Padding="8"
                                Margin="0"
                                DragDrop.AllowDrop="True">
                            <ItemsControl ItemsSource="{Binding SelectedShould}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="4" Width="71" Height="95" Cursor="Hand" DoubleTapped="OnItemDoubleTapped">
                                            <!-- Main card image (NO BORDER!) -->
                                            <Image Source="{Binding ItemImage}"
                                                   Width="71"
                                                   Height="95"
                                                   Stretch="Uniform"/>

                                            <!-- Soul face overlay for legendary jokers -->
                                            <Image Source="{Binding SoulFaceImage}"
                                                   Width="71"
                                                   Height="95"
                                                   Stretch="Uniform"
                                                   IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                                            <!-- Hover-only Remove Button -->
                                            <Button Content="×"
                                                    Command="{Binding $parent[UserControl].DataContext.RemoveFromShouldCommand}"
                                                    CommandParameter="{Binding}"
                                                    Background="{StaticResource Red}"
                                                    Foreground="White"
                                                    FontSize="12"
                                                    FontWeight="Bold"
                                                    Width="18"
                                                    Height="18"
                                                    CornerRadius="9"
                                                    Padding="0"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"
                                                    Margin="0,-6,-6,0"
                                                    IsVisible="False"
                                                    Name="RemoveButton">
                                                <Button.Styles>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="{StaticResource RedHover}"/>
                                                    </Style>
                                                </Button.Styles>
                                            </Button>

                                            <Grid.Styles>
                                                <Style Selector="Grid:pointerover Button#RemoveButton">
                                                    <Setter Property="IsVisible" Value="True"/>
                                                </Style>
                                            </Grid.Styles>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </Border>
                    </StackPanel>

                    <!-- MUST NOT HAVE Zone -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="MUST NOT HAVE"
                                   FontFamily="{StaticResource BalatroFont}"
                                   FontSize="14"
                                   FontWeight="Bold"
                                   Foreground="{StaticResource Red}"
                                   HorizontalAlignment="Left"/>
                        <Border Name="MustNotDropZone"
                                Background="{StaticResource DarkBackground}"
                                BorderBrush="{StaticResource Red}"
                                BorderThickness="2"
                                CornerRadius="8"
                                MinHeight="120"
                                Padding="8"
                                DragDrop.AllowDrop="True">
                            <ItemsControl ItemsSource="{Binding SelectedMustNot}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="4" Width="71" Height="95" Cursor="Hand" DoubleTapped="OnItemDoubleTapped">
                                            <!-- Main card image (NO BORDER!) -->
                                            <Image Source="{Binding ItemImage}"
                                                   Width="71"
                                                   Height="95"
                                                   Stretch="Uniform"/>

                                            <!-- Soul face overlay for legendary jokers -->
                                            <Image Source="{Binding SoulFaceImage}"
                                                   Width="71"
                                                   Height="95"
                                                   Stretch="Uniform"
                                                   IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                                            <!-- Hover-only Remove Button -->
                                            <Button Content="×"
                                                    Command="{Binding $parent[UserControl].DataContext.RemoveFromMustNotCommand}"
                                                    CommandParameter="{Binding}"
                                                    Background="{StaticResource Red}"
                                                    Foreground="White"
                                                    FontSize="12"
                                                    FontWeight="Bold"
                                                    Width="18"
                                                    Height="18"
                                                    CornerRadius="9"
                                                    Padding="0"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"
                                                    Margin="0,-6,-6,0"
                                                    IsVisible="False"
                                                    Name="RemoveButton">
                                                <Button.Styles>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="{StaticResource RedHover}"/>
                                                    </Style>
                                                </Button.Styles>
                                            </Button>

                                            <Grid.Styles>
                                                <Style Selector="Grid:pointerover Button#RemoveButton">
                                                    <Setter Property="IsVisible" Value="True"/>
                                                </Style>
                                            </Grid.Styles>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </Border>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>