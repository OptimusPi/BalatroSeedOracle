<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BalatroSeedOracle.ViewModels.FilterTabs"
             xmlns:i="using:Avalonia.Xaml.Interactivity"
             xmlns:behaviors="using:BalatroSeedOracle.Behaviors"
             xmlns:converters="using:BalatroSeedOracle.Converters"
             x:Class="BalatroSeedOracle.Components.FilterTabs.VisualBuilderTab">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="200"/>   <!-- Left: Category Buttons (Red Sidebar) -->
            <ColumnDefinition Width="550"/>   <!-- Center: Item Grid (narrower) -->
            <ColumnDefinition Width="*"/>     <!-- Right: Drop Zones (wider) -->
        </Grid.ColumnDefinitions>

        <!-- LEFT: Category Buttons + Pagination -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>  <!-- Start Over Button -->
                <RowDefinition Height="*"/>     <!-- Category Buttons -->
                <RowDefinition Height="16"/>    <!-- Spacer -->
                <RowDefinition Height="Auto"/>  <!-- Pagination -->
            </Grid.RowDefinitions>

            <!-- Top Section: Start Over Button -->
            <StackPanel Grid.Row="0" Spacing="8" Margin="0,0,8,12">
                <!-- Start Over Button (matches nav-button dimensions) -->
                <Button Content="START OVER"
                        Classes="btn-orange"
                        MinHeight="45"
                        FontSize="16"

                        Padding="8,4"
                        HorizontalAlignment="Stretch"
                        Click="OnStartOverClick"/>

                <!-- Divider -->
                <Rectangle Height="2"
                           Fill="{StaticResource ModalBorder}"
                           Opacity="0.3"/>
            </StackPanel>

            <!-- Category Buttons (filtered by current page) -->
            <StackPanel Grid.Row="1" Spacing="1" Margin="0,0,8,0">
                <!-- Page 0: JOKERS -->
                <Button Content="ðŸ”¥ Faves" Classes="nav-button" Click="OnCategoryClick" Tag="Favorites"
                        IsVisible="{Binding IsJokersPage}"/>
                <Button Content="ðŸ† Legendary" Classes="nav-button" Click="OnCategoryClick" Tag="Legendary"
                        IsVisible="{Binding IsJokersPage}"/>
                <Button Content="ðŸ’Ž Rare" Classes="nav-button" Click="OnCategoryClick" Tag="Rare"
                        IsVisible="{Binding IsJokersPage}"/>
                <Button Content="ðŸ”¸ Uncommon" Classes="nav-button" Click="OnCategoryClick" Tag="Uncommon"
                        IsVisible="{Binding IsJokersPage}"/>
                <Button Content="âšª Common" Classes="nav-button" Click="OnCategoryClick" Tag="Common"
                        IsVisible="{Binding IsJokersPage}"/>

                <!-- Page 1: CONSUMABLES -->
                <Button Content="ðŸ”® Tarot" Classes="nav-button" Click="OnCategoryClick" Tag="Tarot"
                        IsVisible="{Binding IsConsumablesPage}"/>
                <Button Content="ðŸª Planet" Classes="nav-button" Click="OnCategoryClick" Tag="Planet"
                        IsVisible="{Binding IsConsumablesPage}"/>
                <Button Content="ðŸ‘» Spectral" Classes="nav-button" Click="OnCategoryClick" Tag="Spectral"
                        IsVisible="{Binding IsConsumablesPage}"/>

                <!-- Page 2: MAP -->
                <Button Content="ðŸŽŸï¸ Voucher" Classes="nav-button" Click="OnCategoryClick" Tag="Voucher"
                        IsVisible="{Binding IsMapPage}"/>
                <Button Content="ðŸ·ï¸ Tag" Classes="nav-button" Click="OnCategoryClick" Tag="Tag"
                        IsVisible="{Binding IsMapPage}"/>
                <Button Content="ðŸ‘¹ Boss" Classes="nav-button" Click="OnCategoryClick" Tag="Boss"
                        IsVisible="{Binding IsMapPage}"/>

                <!-- Page 3: CARDS -->
                <Button Content="ðŸƒ Playing Cards" Classes="nav-button" Click="OnCategoryClick" Tag="PlayingCards"
                        IsVisible="{Binding IsCardsPage}"/>
            </StackPanel>

            <!-- Bottom Section: Pagination (matching LOAD tab style) -->
            <StackPanel Grid.Row="3"
                        Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        Spacing="4"
                        Margin="0,20,0,0">
                <Button Content="&lt;"
                        Classes="btn-red"
                        Width="44"
                        Height="36"
                        FontSize="16"
                        Padding="0"
                        CornerRadius="8"
                        Command="{Binding PreviousPageCommand}"/>

                <!-- Page indicator -->
                <Border Background="{StaticResource Red}"
                        BorderBrush="Transparent"
                        BorderThickness="0"
                        CornerRadius="8"
                        Padding="16,8"
                        MinWidth="100"
                        VerticalAlignment="Center">
                    <TextBlock Text="{Binding PageIndicator}"
                               FontFamily="{StaticResource BalatroFont}"
                               FontSize="14"
                               Foreground="White"
                               TextAlignment="Center"/>
                </Border>

                <Button Content="&gt;"
                        Classes="btn-red"
                        Width="44"
                        Height="36"
                        FontSize="16"
                        Padding="0"
                        CornerRadius="8"
                        Command="{Binding NextPageCommand}"/>
            </StackPanel>
        </Grid>

        <!-- CENTER: Item Grid with Search -->
        <Grid Grid.Column="1" Margin="8,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>  <!-- Search Box -->
                <RowDefinition Height="12"/>    <!-- Spacer -->
                <RowDefinition Height="*"/>     <!-- Item Grid -->
            </Grid.RowDefinitions>

            <!-- Search Box (moved from left panel) -->
            <TextBox Grid.Row="0"
                     Text="{Binding SearchFilter}"
                     Watermark="Search items..."
                     MinHeight="45"
                     FontSize="16"
                     BorderThickness="2"
                     BorderBrush="{StaticResource ModalBorder}"
                     Background="{StaticResource DarkBackground}"
                     CornerRadius="8"
                     VerticalContentAlignment="Center"
                     Padding="12,8"/>

            <!-- Item Grid - Dark inner panel with border -->
            <Border Grid.Row="2"
                    Background="{StaticResource DarkTealGrey}"
                    BorderBrush="{StaticResource ModalBorder}"
                    BorderThickness="2"
                    CornerRadius="8"
                    Padding="12"
                    BoxShadow="inset 0 2 4 #00000040">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding FilteredItems}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="8"
                                           Cursor="Hand"
                                           PointerPressed="OnItemPointerPressed"
                                           Opacity="{Binding IsBeingDragged, Converter={x:Static converters:BoolToOpacityConverter.Dragging}}">
                                    <i:Interaction.Behaviors>
                                        <!-- Enabled when NOT being dragged (disable sway on original while ghost is active) -->
                                        <behaviors:CardDragBehavior IsEnabled="{Binding !IsBeingDragged}" JuiceAmount="0.4"/>
                                    </i:Interaction.Behaviors>
                                    <Grid>
                                        <!-- Main card image -->
                                        <Image Source="{Binding ItemImage}"
                                               Width="71"
                                               Height="95"
                                               Stretch="Uniform"
                                               HorizontalAlignment="Center"/>

                                        <!-- Legendary soul face overlay (only for SoulJoker type) -->
                                        <Image Source="{Binding SoulFaceImage}"
                                               Width="71"
                                               Height="95"
                                               Stretch="Uniform"
                                               HorizontalAlignment="Center"
                                               IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                    </Grid>

                                    <!-- Simple name below -->
                                    <TextBlock Text="{Binding DisplayName}"
                                               Foreground="{StaticResource White}"
                                               FontFamily="{StaticResource BalatroFont}"
                                               FontSize="10"
                                               HorizontalAlignment="Center"
                                               TextAlignment="Center"
                                               TextTrimming="CharacterEllipsis"
                                               Margin="0,4,0,0"
                                               MaxWidth="80"/>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- RIGHT: Drop Zones with Proper Visual Containers -->
        <StackPanel Grid.Column="2" Spacing="12" VerticalAlignment="Top">
                    <!-- MUST HAVE Zone -->
                    <Border Name="MustDropZone"
                            Background="{StaticResource DarkTealGrey}"
                            BorderBrush="{StaticResource Green}"
                            BorderThickness="2"
                            CornerRadius="8"
                            MinHeight="120"
                            MaxHeight="220"
                            Padding="12"
                            BoxShadow="inset 0 2 4 #00000040"
                            DragDrop.AllowDrop="True">
                        <Grid>
                            <StackPanel Spacing="8">
                                <TextBlock Text="MUST HAVE"
                                           FontFamily="{StaticResource BalatroFont}"
                                           FontSize="14"

                                           Foreground="{StaticResource Green}"
                                           HorizontalAlignment="Center"
                                           Margin="0,0,0,4"/>
                                <ItemsControl ItemsSource="{Binding SelectedMust}">
                                    <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="4" Width="36" Height="48" Cursor="Hand" DoubleTapped="OnItemDoubleTapped" PointerPressed="OnDropZoneItemPointerPressed">
                                            <!-- Main card image (NO BORDER!) -->
                                            <Image Source="{Binding ItemImage}"
                                                   Width="36"
                                                   Height="48"
                                                   Stretch="Uniform"/>

                                            <!-- Soul face overlay for legendary jokers -->
                                            <Image Source="{Binding SoulFaceImage}"
                                                   Width="36"
                                                   Height="48"
                                                   Stretch="Uniform"
                                                   IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                                            <!-- Hover-only Remove Button -->
                                            <Button Content="Ã—"
                                                    Command="{Binding $parent[UserControl].DataContext.RemoveFromMustCommand}"
                                                    CommandParameter="{Binding}"
                                                    Background="{StaticResource Red}"
                                                    Foreground="White"
                                                    FontSize="12"
                                                    
                                                    Width="18"
                                                    Height="18"
                                                    CornerRadius="9"
                                                    Padding="0"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"
                                                    Margin="0,-6,-6,0"
                                                    IsVisible="False"
                                                    Name="RemoveButton">
                                                <Button.Styles>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="{StaticResource RedHover}"/>
                                                    </Style>
                                                </Button.Styles>
                                            </Button>

                                            <Grid.Styles>
                                                <Style Selector="Grid:pointerover Button#RemoveButton">
                                                    <Setter Property="IsVisible" Value="True"/>
                                                </Style>
                                            </Grid.Styles>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Empty State Placeholder -->
                        <TextBlock Text="Drop items here"
                                   FontFamily="{StaticResource BalatroFont}"
                                   FontSize="12"
                                   Foreground="{StaticResource LightGrey}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Opacity="0.5"
                                   IsVisible="{Binding !SelectedMust.Count}"/>
                    </Grid>
                    </Border>

                    <!-- SHOULD HAVE Zone -->
                    <Border Name="ShouldDropZone"
                            Background="{StaticResource DarkTealGrey}"
                            BorderBrush="{StaticResource Blue}"
                            BorderThickness="2"
                            CornerRadius="8"
                            MinHeight="120"
                            MaxHeight="220"
                            Padding="12"
                            BoxShadow="inset 0 2 4 #00000040"
                            DragDrop.AllowDrop="True">
                        <Grid>
                            <StackPanel Spacing="8">
                                <TextBlock Text="SHOULD HAVE"
                                           FontFamily="{StaticResource BalatroFont}"
                                           FontSize="14"

                                           Foreground="{StaticResource Blue}"
                                           HorizontalAlignment="Center"
                                           Margin="0,0,0,4"/>
                                <ItemsControl ItemsSource="{Binding SelectedShould}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="4" Width="36" Height="48" Cursor="Hand" DoubleTapped="OnItemDoubleTapped" PointerPressed="OnDropZoneItemPointerPressed">
                                            <!-- Main card image (NO BORDER!) -->
                                            <Image Source="{Binding ItemImage}"
                                                   Width="36"
                                                   Height="48"
                                                   Stretch="Uniform"/>

                                            <!-- Soul face overlay for legendary jokers -->
                                            <Image Source="{Binding SoulFaceImage}"
                                                   Width="36"
                                                   Height="48"
                                                   Stretch="Uniform"
                                                   IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                                            <!-- Hover-only Remove Button -->
                                            <Button Content="Ã—"
                                                    Command="{Binding $parent[UserControl].DataContext.RemoveFromShouldCommand}"
                                                    CommandParameter="{Binding}"
                                                    Background="{StaticResource Red}"
                                                    Foreground="White"
                                                    FontSize="12"
                                                    
                                                    Width="18"
                                                    Height="18"
                                                    CornerRadius="9"
                                                    Padding="0"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"
                                                    Margin="0,-6,-6,0"
                                                    IsVisible="False"
                                                    Name="RemoveButton">
                                                <Button.Styles>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="{StaticResource RedHover}"/>
                                                    </Style>
                                                </Button.Styles>
                                            </Button>

                                            <Grid.Styles>
                                                <Style Selector="Grid:pointerover Button#RemoveButton">
                                                    <Setter Property="IsVisible" Value="True"/>
                                                </Style>
                                            </Grid.Styles>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Empty State Placeholder -->
                        <TextBlock Text="Drop items here"
                                   FontFamily="{StaticResource BalatroFont}"
                                   FontSize="12"
                                   Foreground="{StaticResource LightGrey}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Opacity="0.5"
                                   IsVisible="{Binding !SelectedShould.Count}"/>
                    </Grid>
                    </Border>

                    <!-- MUST NOT HAVE Zone -->
                    <Border Name="MustNotDropZone"
                            Background="{StaticResource DarkTealGrey}"
                            BorderBrush="{StaticResource Red}"
                            BorderThickness="2"
                            CornerRadius="8"
                            MinHeight="120"
                            MaxHeight="220"
                            Padding="12"
                            BoxShadow="inset 0 2 4 #00000040"
                            DragDrop.AllowDrop="True">
                        <Grid>
                            <StackPanel Spacing="8">
                                <TextBlock Text="MUST NOT HAVE"
                                           FontFamily="{StaticResource BalatroFont}"
                                           FontSize="14"

                                           Foreground="{StaticResource Red}"
                                           HorizontalAlignment="Center"
                                           Margin="0,0,0,4"/>
                                <ItemsControl ItemsSource="{Binding SelectedMustNot}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="4" Width="36" Height="48" Cursor="Hand" DoubleTapped="OnItemDoubleTapped" PointerPressed="OnDropZoneItemPointerPressed">
                                            <!-- Main card image (NO BORDER!) -->
                                            <Image Source="{Binding ItemImage}"
                                                   Width="36"
                                                   Height="48"
                                                   Stretch="Uniform"/>

                                            <!-- Soul face overlay for legendary jokers -->
                                            <Image Source="{Binding SoulFaceImage}"
                                                   Width="36"
                                                   Height="48"
                                                   Stretch="Uniform"
                                                   IsVisible="{Binding SoulFaceImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                                            <!-- Hover-only Remove Button -->
                                            <Button Content="Ã—"
                                                    Command="{Binding $parent[UserControl].DataContext.RemoveFromMustNotCommand}"
                                                    CommandParameter="{Binding}"
                                                    Background="{StaticResource Red}"
                                                    Foreground="White"
                                                    FontSize="12"
                                                    
                                                    Width="18"
                                                    Height="18"
                                                    CornerRadius="9"
                                                    Padding="0"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"
                                                    Margin="0,-6,-6,0"
                                                    IsVisible="False"
                                                    Name="RemoveButton">
                                                <Button.Styles>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="{StaticResource RedHover}"/>
                                                    </Style>
                                                </Button.Styles>
                                            </Button>

                                            <Grid.Styles>
                                                <Style Selector="Grid:pointerover Button#RemoveButton">
                                                    <Setter Property="IsVisible" Value="True"/>
                                                </Style>
                                            </Grid.Styles>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Empty State Placeholder -->
                        <TextBlock Text="Drop items here"
                                   FontFamily="{StaticResource BalatroFont}"
                                   FontSize="12"
                                   Foreground="{StaticResource LightGrey}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Opacity="0.5"
                                   IsVisible="{Binding !SelectedMustNot.Count}"/>
                    </Grid>
                    </Border>
        </StackPanel>
    </Grid>
</UserControl>
