<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BalatroSeedOracle.ViewModels"
             xmlns:i="using:Avalonia.Xaml.Interactivity"
             xmlns:behaviors="using:BalatroSeedOracle.Behaviors"
             x:Class="BalatroSeedOracle.Components.GenieWidget"
             x:DataType="vm:GenieWidgetViewModel"
             x:CompileBindings="True">

    <!-- Single container with the drag behavior -->
    <Grid HorizontalAlignment="Left" VerticalAlignment="Top"
          ZIndex="{Binding WidgetZIndex}">
        <i:Interaction.Behaviors>
            <behaviors:DraggableWidgetBehavior X="{Binding PositionX, Mode=TwoWay}"
                                               Y="{Binding PositionY, Mode=TwoWay}" />
        </i:Interaction.Behaviors>

        <!-- Minimized State - Magic Lamp Icon -->
        <StackPanel Name="MinimizedView"
                    IsVisible="{Binding IsMinimized}"
                    Spacing="4">
            <i:Interaction.Behaviors>
                <!-- BALATRO SWAY ANIMATION! -->
                <behaviors:BalatroCardSwayBehavior AmbientTilt="0.2" />
            </i:Interaction.Behaviors>

            <Border Background="{StaticResource Grey}"
                    BorderBrush="{StaticResource ModalBorder}"
                    BorderThickness="2"
                    CornerRadius="8"
                    Width="64" Height="64"
                    Cursor="Hand"
                    PointerPressed="OnMinimizedIconPressed"
                    PointerReleased="OnMinimizedIconReleased">
                <TextBlock Text="ðŸ§ž" FontSize="28" HorizontalAlignment="Center" VerticalAlignment="Center"/>
            </Border>
            <TextBlock Text="Genie"
                       FontSize="10"
                       FontWeight="Bold"
                       Foreground="White"
                       HorizontalAlignment="Center"/>
        </StackPanel>

        <!-- Expanded State - Full Genie Interface -->
        <Border Name="ExpandedView"
                Classes="widget-window"
                IsVisible="{Binding !IsMinimized}"
                ZIndex="100"
                Width="420"
                MaxHeight="600">

            <Grid RowDefinitions="Auto,*">
                <!-- Header with Title and Minimize Button -->
                <Border Grid.Row="0" Classes="widget-header" Padding="12,8">
                    <Grid ColumnDefinitions="Auto,*">
                        <Button Grid.Column="0"
                                Content="â†™"
                                Classes="widget-minimize-btn"
                                Command="{Binding MinimizeCommand}"
                                ToolTip.Tip="Minimize"
                                Margin="0,0,8,0"/>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="{Binding WidgetIcon}" FontSize="15" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding WidgetTitle}"
                                       FontSize="13"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Content Area -->
                <ScrollViewer Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Margin="15" Spacing="12">

                            <!-- Prompt Input -->
                            <StackPanel Spacing="6">
                                <TextBlock Text="âœ¨ Describe your dream seed:"
                                           FontWeight="Bold"
                                           FontSize="12"
                                           Foreground="{StaticResource InfoTextPrecise}"/>
                                <TextBox Classes="widget-prompt-input"
                                         Text="{Binding UserPrompt}"
                                         Watermark="e.g. 'Find me a Perkeo with Blueprint and Negative tags'"
                                         MaxHeight="120"/>
                            </StackPanel>

                            <!-- Generate Button -->
                            <Button Classes="widget-secondary-btn"
                                    Command="{Binding GenerateFilterCommand}"
                                    IsEnabled="{Binding !IsGenerating}"
                                    HorizontalAlignment="Stretch">
                                <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding GenerateButtonText}" FontSize="13"/>
                                    <TextBlock Text="{Binding GeneratingSpinner}" FontSize="13" IsVisible="{Binding IsGenerating}"/>
                                </StackPanel>
                            </Button>

                            <!-- Status Message -->
                            <TextBlock Text="{Binding StatusMessage}"
                                       Foreground="{Binding StatusColor}"
                                       FontSize="11"
                                       TextWrapping="Wrap"
                                       IsVisible="{Binding HasStatusMessage}"/>

                            <!-- Generated Config Preview -->
                            <Border IsVisible="{Binding HasGeneratedConfig}"
                                    Background="{StaticResource DarkBackground}"
                                    BorderBrush="{StaticResource Blue}"
                                    BorderThickness="2"
                                    CornerRadius="6"
                                    Padding="10">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="âœ… Generated Filter:"
                                               FontWeight="Bold"
                                               FontSize="11"
                                               Foreground="{StaticResource Blue}"/>

                                    <TextBlock Text="{Binding GeneratedFilterName}"
                                               FontWeight="Bold"
                                               FontSize="12"
                                               Foreground="{StaticResource TextLight}"/>

                                    <TextBlock Text="{Binding GeneratedFilterSummary}"
                                               FontSize="10"
                                               Foreground="{StaticResource InfoTextPrecise}"
                                               TextWrapping="Wrap"/>

                                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8" Margin="0,4,0,0">
                                        <Button Grid.Column="0"
                                                Content="ðŸ’¾ Save"
                                                Command="{Binding SaveFilterCommand}"
                                                Classes="btn-green"
                                                FontSize="11"
                                                Padding="8,4"/>
                                        <Button Grid.Column="1"
                                                Content="ðŸ” Search"
                                                Command="{Binding SearchFilterCommand}"
                                                Classes="btn-blue"
                                                FontSize="11"
                                                Padding="8,4"/>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Quick Examples -->
                            <Expander Header="ðŸ’¡ Example Prompts" FontSize="11">
                                <StackPanel Spacing="6" Margin="0,8,0,0">
                                    <Button Content="ðŸŽ´ Perkeo with Blueprint and Brainstorm"
                                            Command="{Binding UseExampleCommand}"
                                            CommandParameter="Find me a Ghost Deck seed with Perkeo soul joker, Blueprint, and Brainstorm in antes 1-3"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Background="Transparent"
                                            FontSize="10"
                                            Padding="6,4"/>
                                    <Button Content="ðŸ·ï¸ Negative tags in early game"
                                            Command="{Binding UseExampleCommand}"
                                            CommandParameter="Get me seeds with Negative tags on antes 2 and 3"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Background="Transparent"
                                            FontSize="10"
                                            Padding="6,4"/>
                                    <Button Content="ðŸ’° Economy build with vouchers"
                                            Command="{Binding UseExampleCommand}"
                                            CommandParameter="Green deck with Egg, Bull, and Observatory voucher"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Background="Transparent"
                                            FontSize="10"
                                            Padding="6,4"/>
                                    <Button Content="âŒ Avoid specific jokers"
                                            Command="{Binding UseExampleCommand}"
                                            CommandParameter="Any seed without Chicot or The Idol"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Background="Transparent"
                                            FontSize="10"
                                            Padding="6,4"/>
                                </StackPanel>
                            </Expander>

                        </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>
