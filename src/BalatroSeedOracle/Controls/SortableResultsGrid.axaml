<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BalatroSeedOracle.ViewModels.Controls"
             xmlns:material="clr-namespace:IconPacks.Avalonia.Material;assembly=IconPacks.Avalonia.Material"
             x:Class="BalatroSeedOracle.Controls.SortableResultsGrid"
             x:DataType="vm:SortableResultsGridViewModel">

    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Stats and Actions Header -->
        <Border Grid.Row="0" 
                Background="{StaticResource DarkBackground}" 
                Padding="12,8"
                BorderBrush="{StaticResource ModalBorder}"
                BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="*,Auto">
                <!-- Stats Text -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="15" VerticalAlignment="Center">
                    <TextBlock Text="{Binding ResultsCountText}" 
                               FontFamily="{StaticResource BalatroFont}"
                               FontSize="16"
                               Foreground="{StaticResource Gold}"/>
                    <TextBlock Text="{Binding StatsText}" 
                               FontSize="12"
                               Foreground="{StaticResource LightGrey}"
                               VerticalAlignment="Center"
                               Margin="0,2,0,0"/>
                    <TextBlock Text="{Binding SelectedCountText}" 
                               FontSize="12"
                               Foreground="{StaticResource BrightGreenEditor}"
                               VerticalAlignment="Center"
                               Margin="8,2,0,0"
                               IsVisible="{Binding HasSelection}"/>
                </StackPanel>

                <!-- Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <!-- Sort Dropdown (Legacy support) -->
                    <StackPanel Orientation="Horizontal" Spacing="5" Margin="0,0,10,0">
                        <TextBlock Text="SORT:" VerticalAlignment="Center" FontSize="11" Foreground="{StaticResource MediumGrey}"/>
                        <ComboBox SelectedIndex="{Binding SelectedSortIndex}" Height="30" FontSize="12">
                            <ComboBoxItem Content="SEED (A-Z)"/>
                            <ComboBoxItem Content="SCORE (DESC)"/>
                            <ComboBoxItem Content="SCORE (ASC)"/>
                        </ComboBox>
                    </StackPanel>

                    <Button Command="{Binding CopySelectedCommand}" 
                            ToolTip.Tip="Copy selected seeds (Ctrl+C)"
                            Classes="btn-blue"
                            Padding="8,4"
                            IsEnabled="{Binding HasSelection}">
                        <material:PackIconMaterial Kind="ContentCopy" Width="14" Height="14"/>
                    </Button>
                    <Button Command="{Binding ExportSelectedCommand}" 
                            ToolTip.Tip="Export selected results"
                            Classes="btn-green"
                            Padding="8,4"
                            IsEnabled="{Binding HasSelection}">
                        <material:PackIconMaterial Kind="FileExport" Width="14" Height="14"/>
                    </Button>
                    <Button Command="{Binding PopOutCommand}" 
                            ToolTip.Tip="Open in new window"
                            Classes="btn-blue"
                            Padding="8,4">
                        <material:PackIconMaterial Kind="OpenInNew" Width="14" Height="14"/>
                    </Button>
                    <Button Command="{Binding ExportAllCommand}" 
                            ToolTip.Tip="Export all results"
                            Classes="btn-green"
                            Padding="8,4">
                        <material:PackIconMaterial Kind="FileExport" Width="14" Height="14"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Quick Search/Filter Bar -->
        <Border Grid.Row="1"
                Background="{StaticResource DarkBackground}"
                BorderBrush="{StaticResource ModalBorder}"
                BorderThickness="0,0,0,1"
                Padding="12,8">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                <TextBlock Grid.Column="0"
                           Text="ðŸ”"
                           FontSize="16"
                           VerticalAlignment="Center"
                           Margin="0,0,8,0"/>
                <TextBox Grid.Column="1"
                         Text="{Binding QuickFilterText}"
                         Watermark="Quick filter (seed, score, or any column)..."
                         FontSize="12"
                         VerticalAlignment="Center"/>
                <Button Grid.Column="2"
                        Command="{Binding ClearFilterCommand}"
                        Content="Clear"
                        Margin="8,0,0,0"
                        Padding="8,4"
                        IsEnabled="{Binding HasFilter}"
                        Classes="btn-blue"/>
                <Button Grid.Column="3"
                        Command="{Binding ToggleColumnMenuCommand}"
                        ToolTip.Tip="Column visibility"
                        Margin="8,0,0,0"
                        Padding="8,4"
                        Classes="btn-blue">
                    <material:PackIconMaterial Kind="ViewColumn" Width="14" Height="14"/>
                </Button>
            </Grid>
        </Border>

        <!-- Results Grid -->
        <DataGrid Grid.Row="2"
                  Name="ResultsDataGrid"
                  ItemsSource="{Binding DisplayedResults}"
                  AutoGenerateColumns="False"
                  CanUserSortColumns="True"
                  CanUserResizeColumns="True"
                  CanUserReorderColumns="True"
                  GridLinesVisibility="All"
                  HeadersVisibility="Column"
                  IsReadOnly="True"
                  SelectionMode="Extended"
                  Background="{StaticResource DarkBackground}"
                  Foreground="White"
                  RowBackground="{StaticResource DarkBackground}"
                  SelectedItem="{Binding SelectedItem}">
            <DataGrid.Columns>
                <DataGridTemplateColumn Header="SEED" Width="150" CanUserSort="True" SortMemberPath="Seed">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Text="{Binding Seed}" 
                                           FontFamily="{StaticResource BalatroFont}"
                                           FontSize="14"
                                           VerticalAlignment="Center"
                                           Margin="8,0"/>
                                <Button Grid.Column="1" 
                                        Command="{Binding $parent[UserControl].ViewModel.CopySeedCommand}"
                                        CommandParameter="{Binding Seed}"
                                        Classes="btn-blue"
                                        Padding="4" Margin="0,0,4,0"
                                        ToolTip.Tip="Copy Seed">
                                    <material:PackIconMaterial Kind="ContentCopy" Width="12" Height="12"/>
                                </Button>
                            </Grid>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTextColumn Header="SCORE" 
                                    Binding="{Binding TotalScore}" 
                                    Width="100" 
                                    CanUserSort="True" 
                                    SortMemberPath="TotalScore"/>

                <!-- Dynamic Tally Columns are inserted here by code-behind -->

                <DataGridTemplateColumn Header="ACTIONS" Width="100">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                <Button Command="{Binding $parent[UserControl].ViewModel.AnalyzeCommand}"
                                        CommandParameter="{Binding}"
                                        Classes="btn-green"
                                        Padding="6,3"
                                        ToolTip.Tip="Analyze this seed">
                                    <material:PackIconMaterial Kind="Magnify" Width="14" Height="14"/>
                                </Button>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>
    </Grid>
</UserControl>
