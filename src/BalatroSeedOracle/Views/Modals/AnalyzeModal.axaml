<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="using:BalatroSeedOracle.Controls"
             xmlns:components="using:BalatroSeedOracle.Components"
             xmlns:vm="using:BalatroSeedOracle.ViewModels"
             xmlns:models="using:BalatroSeedOracle.Models"
             xmlns:converters="using:BalatroSeedOracle.Converters"
             xmlns:features="using:BalatroSeedOracle.Features.Analyzer"
             xmlns:material="clr-namespace:IconPacks.Avalonia.Material;assembly=IconPacks.Avalonia.Material"
             xmlns:icons="clr-namespace:IconPacks.Avalonia.Material;assembly=IconPacks.Avalonia.Material"
             x:Class="BalatroSeedOracle.Views.Modals.AnalyzeModal"
             x:DataType="vm:AnalyzeModalViewModel">
    
    <UserControl.Resources>
        <converters:ShopItemSpriteConverter x:Key="ShopItemSpriteConverter"/>
        <converters:BoosterPackSpriteConverter x:Key="BoosterPackSpriteConverter"/>
        <converters:TagSpriteConverter x:Key="TagSpriteConverter"/>
    </UserControl.Resources>

    <!-- Remove local styles in favor of global Balatro styles -->

    <!-- DataTemplates -->
    <UserControl.DataTemplates>
        <!-- Shop Item Template -->
        <DataTemplate DataType="models:ShopItemModel">
            <Border Classes="modal-content-box" Width="100" Height="140">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <!-- Item Sprite -->
                    <Image Source="{Binding Converter={StaticResource ShopItemSpriteConverter}}"
                           Width="71" Height="95"
                           Stretch="UniformToFill"/>

                    <!-- Edition Badge -->
                    <TextBlock Text="{Binding EditionName}"
                              FontSize="10"
                              HorizontalAlignment="Center"
                              Foreground="{Binding EditionColor}"
                              IsVisible="{Binding HasEdition}"/>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- Booster Pack Template -->
        <DataTemplate DataType="models:BoosterPackModel">
            <Border Classes="modal-content-box" MinWidth="100" MaxWidth="150" MinHeight="140" Margin="4">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <!-- Pack Sprite -->
                    <Image Source="{Binding Converter={StaticResource BoosterPackSpriteConverter}}"
                           Width="71" Height="95"
                           Stretch="Uniform"/>

                    <!-- Pack Info -->
                    <StackPanel>
                        <TextBlock Text="{Binding PackName}"
                                  FontSize="10"
                                  HorizontalAlignment="Center"/>

                        <TextBlock Text="{Binding ItemsText}"
                                  FontSize="8"
                                  HorizontalAlignment="Center"
                                  TextWrapping="Wrap"
                                  MaxWidth="90"
                                  Opacity="0.8"
                                  Margin="0,2,0,0"
                                  IsVisible="{Binding HasItems}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- Tag Template -->
        <DataTemplate DataType="models:TagModel">
            <Border Classes="modal-content-box" CornerRadius="20" Padding="12,8" Margin="4">
                <StackPanel Orientation="Horizontal">
                    <!-- Tag Sprite -->
                    <Image Source="{Binding Converter={StaticResource TagSpriteConverter}}"
                           Width="34" Height="34"
                           Stretch="UniformToFill"
                           Margin="0,0,8,0"/>

                    <!-- Tag Info -->
                    <StackPanel>
                        <TextBlock Text="{Binding BlindType}"
                                  FontSize="10"
                                  Opacity="0.7"/>
                        <TextBlock Text="{Binding TagName}"
                                  FontSize="12"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- Ante Template -->
        <DataTemplate DataType="models:AnteAnalysisModel">
            <Border Classes="BalatroSeedOracle-modal-card-precise" Padding="20">
                <StackPanel>
                    <!-- Ante Header -->
                    <TextBlock Text="{Binding AnteTitle}" Classes="balatro-section-header"/>

                    <!-- Voucher Section -->
                    <StackPanel IsVisible="{Binding HasVoucher}">
                        <TextBlock Text="VOUCHER" FontSize="16" Margin="0,10,0,5"/>
                        <TextBlock Text="{Binding VoucherName}" FontSize="14" Margin="20,0,0,10"/>
                    </StackPanel>

                    <!-- Shop Section -->
                    <StackPanel IsVisible="{Binding HasShopItems}">
                        <TextBlock Text="SHOP" FontSize="16" Margin="0,10,0,5"/>
                        <ItemsControl ItemsSource="{Binding ShopItems}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </StackPanel>

                    <!-- Booster Packs Section -->
                    <StackPanel IsVisible="{Binding HasBoosterPacks}">
                        <TextBlock Text="BOOSTER PACKS" FontSize="16" Margin="0,15,0,5"/>
                        <ItemsControl ItemsSource="{Binding BoosterPacks}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </StackPanel>

                    <!-- Tags Section -->
                    <StackPanel>
                        <TextBlock Text="SKIP TAGS" FontSize="16" Margin="0,15,0,5"/>
                        <WrapPanel Orientation="Horizontal">
                            <ContentControl Content="{Binding SmallBlindTag}"/>
                            <ContentControl Content="{Binding BigBlindTag}"/>
                        </WrapPanel>
                    </StackPanel>
                </StackPanel>
            </Border>
        </DataTemplate>
    </UserControl.DataTemplates>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Tabs -->
            <RowDefinition Height="*"/>    <!-- Content -->
        </Grid.RowDefinitions>

        <!-- Balatro-style tab control with automatic triangle positioning -->
        <controls:BalatroTabControl Grid.Row="0"
                                    HorizontalAlignment="Center"
                                    Margin="0,0,0,2"
                                    SelectedIndex="{Binding ActiveTab, Converter={x:Static converters:EnumToIntConverter.Instance}}">
            <controls:BalatroTabControl.Items>
                <TabItem Header="DECK/STAKE"/>
                <TabItem Header="ANALYZE"/>
            </controls:BalatroTabControl.Items>
        </controls:BalatroTabControl>
        
        <!-- Content panels -->
        <Grid Grid.Row="1">
            <!-- Settings Panel (Deck/Stake) -->
            <StackPanel IsVisible="{Binding SettingsTabVisible}" Spacing="24">
                <!-- Explanatory Text -->
                <TextBlock Text="Peek inside any seed to see what the shops, packs, and skip tags look like for each ante!"
                          FontFamily="{StaticResource BalatroFont}"
                          FontSize="13"
                          Foreground="{StaticResource VeryLightGrey}"
                          TextWrapping="Wrap"
                          HorizontalAlignment="Center"
                          TextAlignment="Center"
                          Opacity="0.8"
                          Margin="0,8,0,0"/>

                <!-- Deck and Stake selector (no wrapper needed - component styles itself) -->
                <components:DeckAndStakeSelector Name="DeckAndStakeSelector"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"/>
            </StackPanel>
            
            <!-- Analyzer Panel -->
            <ScrollViewer IsVisible="{Binding AnalyzerTabVisible}" VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!-- Input Section -->
                    <Border Classes="modal-content-panel" Margin="10">
                        <Grid Margin="15" ColumnSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*" MaxWidth="300"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Seed Input -->
                            <TextBlock Grid.Column="0"
                                      Text="Seed:"
                                      VerticalAlignment="Center"
                                      Margin="0,0,10,0"
                                      FontSize="16"
                                      Foreground="{StaticResource White}"/>

                            <TextBox Grid.Column="1"
                                    Text="{Binding SeedInput}"
                                    FontSize="16"
                                    MaxLength="8"
                                    Watermark="Enter seed..."
                                    VerticalAlignment="Center"
                                    Height="40"
                                    Margin="0,0,15,0"
                                    CornerRadius="6"
                                    BorderThickness="0"/>

                            <!-- Analyze Button -->
                            <Button Grid.Column="2"
                                   Content="ANALYZE"
                                   Command="{Binding AnalyzeSeedCommand}"
                                   MinWidth="120"
                                   FontSize="16"
                                   CornerRadius="6"
                                   Height="44"
                                   Classes="btn-green"/>

                            <!-- Pop-out Analyzer Button -->
                            <Button Grid.Column="3"
                                   Content="POP-OUT"
                                   Command="{Binding PopOutAnalyzerCommand}"
                                   MinWidth="100"
                                   FontSize="16"
                                   CornerRadius="6"
                                   Height="44"
                                   Classes="btn-blue"/>
                        </Grid>
                    </Border>

                    <!-- Results Section -->
                    <StackPanel Margin="5">
                        <!-- Placeholder -->
                        <Border Classes="BalatroSeedOracle-modal-card-precise"
                               Padding="40"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Margin="20"
                               IsVisible="{Binding ShowPlaceholder}">
                            <StackPanel>
                                <icons:PackIconMaterial Kind="CardsOutline"
                                          Width="48" Height="48"
                                          HorizontalAlignment="Center"
                                          Foreground="{StaticResource White}"
                                          Margin="0,0,0,10"/>
                                <TextBlock Text="Enter a seed and click ANALYZE"
                                          HorizontalAlignment="Center"
                                          FontSize="18"
                                          Foreground="{StaticResource White}"/>
                                <TextBlock Text="View shop contents, booster packs, and skip tags for each ante"
                                          HorizontalAlignment="Center"
                                          FontSize="14"
                                          Margin="0,5,0,0"
                                          Opacity="0.7"/>
                            </StackPanel>
                        </Border>

                        <!-- Analysis Header -->
                        <StackPanel Margin="0,0,0,10" IsVisible="{Binding HasAnalysisResults}">
                            <TextBlock Text="{Binding AnalysisHeader}"
                                      FontSize="20"
                                      HorizontalAlignment="Center"
                                      Margin="0,10,0,5"/>
                        </StackPanel>

                        <!-- Analysis Display -->
                        <features:SeedAnalysisDisplay DataContext="{Binding CurrentAnalysis}"/>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>
