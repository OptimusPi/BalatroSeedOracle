<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:AvaloniaEdit="clr-namespace:AvaloniaEdit;assembly=AvaloniaEdit"
             xmlns:vm="using:BalatroSeedOracle.ViewModels.FilterTabs"
             xmlns:icons="https://github.com/MahApps/IconPacks.Avalonia"
             xmlns:components="using:BalatroSeedOracle.Components"
             xmlns:filterTabs="clr-namespace:BalatroSeedOracle.Components.FilterTabs"
             xmlns:models="using:BalatroSeedOracle.Models"
             x:Class="BalatroSeedOracle.Components.FilterTabs.JamlEditorTab"
             x:DataType="vm:JamlEditorTabViewModel">
    <Border Grid.Row="0"
            Background="{StaticResource EditorDarkBg}"
            BorderThickness="0"
            CornerRadius="12"
            Padding="0"
            BoxShadow="{StaticResource InsetInputShadow}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="320"/>
            </Grid.ColumnDefinitions>

            <!-- Editor Header Bar -->
            <Border Grid.Row="0"
                    Grid.Column="0"
                    Grid.ColumnSpan="2"
                    Background="{StaticResource EditorHeaderBg}"
                    BorderBrush="{StaticResource EditorBorderBg}"
                    BorderThickness="0,0,0,1"
                    CornerRadius="12,12,0,0"
                    Padding="12,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding FilterFileName}"
                                    Foreground="{StaticResource EditorTextGrey}"
                                    FontFamily="{StaticResource BalatroFont}"
                                    FontSize="14"
                                    VerticalAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6">
                        <Button Content="Format"
                                ToolTip.Tip="Auto-format JAML"
                                Command="{Binding FormatJamlCommand}"
                                Height="24"
                                Padding="8,4"
                                FontSize="11"
                                Background="{StaticResource EditorButtonBg}"
                                BorderThickness="0"
                                CornerRadius="4"
                                Foreground="{StaticResource BrightGold}"/>
                        <Button Content="Sync to Visual"
                                ToolTip.Tip="Apply changes to the Visual Builder"
                                Command="{Binding SyncToVisualCommand}"
                                IsEnabled="{Binding !HasError}"
                                Height="24"
                                Padding="8,4"
                                FontSize="11"
                                Background="{StaticResource EditorButtonBg}"
                                BorderThickness="0"
                                CornerRadius="4"
                                Foreground="{StaticResource BrightGreenEditor}"/>
                        <Button ToolTip.Tip="Copy JAML to clipboard"
                                Command="{Binding CopyJamlCommand}"
                                Height="24"
                                Padding="8,4"
                                FontSize="11"
                                Background="{StaticResource EditorButtonBg}"
                                BorderThickness="0"
                                CornerRadius="4">
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <icons:PackIconMaterial Kind="ContentCopy" Width="12" Height="12" Foreground="{StaticResource Blue}"/>
                                <TextBlock Text="Copy JAML" Foreground="{StaticResource Blue}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Editor Content -->
            <AvaloniaEdit:TextEditor Grid.Row="1"
                                    Grid.Column="0"
                                    Name="JamlEditor"
                                    SyntaxHighlighting="YAML"
                                    ShowLineNumbers="True"
                                    FontFamily="Cascadia Code,Consolas,Menlo,Courier New,monospace"
                                    FontSize="16"
                                    Background="{StaticResource EditorDarkBg}"
                                    Foreground="{StaticResource White}"
                                    LineNumbersForeground="{StaticResource EditorLineNumbers}"
                                    Margin="0"
                                    Padding="12,8"
                                    HorizontalScrollBarVisibility="Auto"
                                    VerticalScrollBarVisibility="Auto"/>

            <!-- Preview Panel -->
            <Border Grid.Row="1" 
                    Grid.Column="1"
                    Background="{StaticResource EditorDarkBg}"
                    BorderBrush="{StaticResource EditorBorderBg}"
                    BorderThickness="1,0,0,0">
                <Grid RowDefinitions="Auto,*">
                    <TextBlock Grid.Row="0" 
                               Text="PREVIEW" 
                               Foreground="{StaticResource EditorTextGrey}"
                               FontSize="10"
                               Margin="8,4"
                               HorizontalAlignment="Center"
                               FontFamily="{StaticResource BalatroFont}"/>
                    
                    <ScrollViewer Grid.Row="1">
                        <ItemsControl ItemsSource="{Binding PreviewItems}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel HorizontalAlignment="Center"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="models:FilterItem">
                                    <Border Margin="8">
                                        <Border.RenderTransform>
                                            <ScaleTransform ScaleX="0.8" ScaleY="0.8"/>
                                        </Border.RenderTransform>
                                        <StackPanel>
                                            <Border Name="CategoryIndicator" 
                                                    Height="4" 
                                                    VerticalAlignment="Top" 
                                                    Margin="0,0,0,8"
                                                    CornerRadius="2">
                                                <Border.Styles>
                                                    <Style Selector="Border">
                                                        <Setter Property="Background" Value="{StaticResource BrightGold}"/>
                                                    </Style>
                                                    <Style Selector="Border[Tag=Must]">
                                                        <Setter Property="Background" Value="{StaticResource BrightGreenEditor}"/>
                                                    </Style>
                                                </Border.Styles>
                                                <Border.Tag>
                                                    <Binding Path="Category"/>
                                                </Border.Tag>
                                            </Border>
                                            
                                            <!-- Reuse the self-contained FilterItemCard -->
                                            <components:FilterItemCard DataContext="{Binding}"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Validation Status Bar -->
            <Border Grid.Row="2"
                    Grid.Column="0"
                    Grid.ColumnSpan="2"
                    Background="{StaticResource EditorHeaderBg}"
                    BorderBrush="{StaticResource EditorBorderBg}"
                    BorderThickness="0,1,0,0"
                    CornerRadius="0,0,12,12"
                    Padding="12,4">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding ValidationStatus}"
                                   Foreground="{Binding ValidationStatusColor}"
                                   FontWeight="Bold"
                                   FontSize="12"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <TextBlock Grid.Column="1"
                               Text="{Binding ErrorMessage}"
                               Foreground="{StaticResource Red}"
                               FontSize="11"
                               Margin="16,0"
                               TextTrimming="CharacterEllipsis"
                               VerticalAlignment="Center"
                               IsVisible="{Binding HasError}"/>
                </Grid>
            </Border>

            <!-- Error Panel -->
            <filterTabs:JamlErrorPanel Grid.Row="3"
                                       Grid.Column="0"
                                       Grid.ColumnSpan="2"
                                       DataContext="{Binding}"
                                       MaxHeight="200"
                                       IsVisible="{Binding HasErrors}"/>
        </Grid>
    </Border>
</UserControl>
