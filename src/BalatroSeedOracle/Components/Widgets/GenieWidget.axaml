<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BalatroSeedOracle.ViewModels"
             xmlns:i="using:Avalonia.Xaml.Interactivity"
             xmlns:behaviors="using:BalatroSeedOracle.Behaviors"
             xmlns:local="using:BalatroSeedOracle.Components"
             xmlns:material="clr-namespace:IconPacks.Avalonia.Material;assembly=IconPacks.Avalonia.Material"
             x:Class="BalatroSeedOracle.Components.GenieWidget"
             x:DataType="vm:GenieWidgetViewModel"
             x:CompileBindings="True"
             Panel.ZIndex="{Binding WidgetZIndex}">

    <!-- Single container with the drag behavior -->
    <Grid HorizontalAlignment="Left" VerticalAlignment="Top">
        <i:Interaction.Behaviors>
            <behaviors:DraggableWidgetBehavior X="{Binding PositionX, Mode=TwoWay}"
                                               Y="{Binding PositionY, Mode=TwoWay}"
                                               DragHandleClass="widget-header" />
        </i:Interaction.Behaviors>

        <!-- Minimized State - Magic Lamp Icon -->
        <StackPanel Name="MinimizedView"
                    IsVisible="{Binding IsMinimized}"
                    Spacing="4">
            <i:Interaction.Behaviors>
                <!-- BALATRO SWAY ANIMATION! -->
                <behaviors:BalatroCardSwayBehavior AmbientTilt="0.2" />
            </i:Interaction.Behaviors>

            <Border Background="{StaticResource ModalGrey}"
                    BorderBrush="{StaticResource ModalBorder}"
                    BorderThickness="2"
                    CornerRadius="8"
                    Width="64" Height="64"
                    Classes="widget-header"
                    Cursor="Hand"
                    PointerPressed="OnMinimizedIconPressed"
                    PointerReleased="OnMinimizedIconReleased">
                        <material:PackIconMaterial Kind="Lamp" Width="28" Height="28" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource White}"/>
            </Border>
            <TextBlock Text="Genie"
                       FontSize="16"
                       FontFamily="{StaticResource BalatroFont}"
                       Foreground="{StaticResource White}"
                       HorizontalAlignment="Center"/>
        </StackPanel>

        <!-- Expanded State - Full Genie Interface -->
        <Border Name="ExpandedView"
                Classes="widget-window"
                IsVisible="{Binding !IsMinimized}"
                Width="420"
                MaxHeight="600">

            <Grid RowDefinitions="Auto,*">
                <!-- Header using shared component -->
                <local:WidgetHeader Grid.Row="0" />

                <!-- Content Area -->
                <ScrollViewer Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Margin="15" Spacing="12">

                            <!-- Prompt Input -->
                            <StackPanel Spacing="6">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <material:PackIconMaterial Kind="AutoFix" Width="14" Height="14" Foreground="{StaticResource White}" VerticalAlignment="Center"/>
                                    <TextBlock Text="Describe your dream seed:"
                                               FontFamily="{StaticResource BalatroFont}"
                                               FontSize="12"
                                               Foreground="{StaticResource White}"/>
                                </StackPanel>
                                <TextBox Classes="widget-prompt-input"
                                         Text="{Binding UserPrompt}"
                                         Watermark="e.g. 'Find me a Perkeo with Blueprint and Negative tags'"
                                         MaxHeight="120"/>
                            </StackPanel>

                            <!-- Generate Button -->
                            <Button Content="{Binding ButtonContent}"
                                    Command="{Binding GenerateFilterCommand}"
                                    IsEnabled="{Binding !IsGenerating}"
                                    HorizontalAlignment="Stretch"/>

                            <!-- Status Message -->
                            <TextBlock Text="{Binding StatusMessage}"
                                       Foreground="{Binding StatusColor}"
                                       FontSize="11"
                                       TextWrapping="Wrap"
                                       IsVisible="{Binding HasStatusMessage}"/>

                            <!-- Generated Config Preview -->
                            <Border IsVisible="{Binding HasGeneratedConfig}"
                                    Background="{StaticResource DarkBackground}"
                                    BorderBrush="{StaticResource Blue}"
                                    BorderThickness="2"
                                    CornerRadius="6"
                                    Padding="10">
                                <StackPanel Spacing="8">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <icons:PackIconMaterial Kind="CheckCircle" Width="12" Height="12" Foreground="{StaticResource Blue}" VerticalAlignment="Center"/>
                                        <TextBlock Text="Generated Filter:"
                                                   FontFamily="{StaticResource BalatroFont}"
                                                   FontSize="11"
                                                   Foreground="{StaticResource Blue}"/>
                                    </StackPanel>

                                    <TextBlock Text="{Binding GeneratedFilterName}"
                                               FontFamily="{StaticResource BalatroFont}"
                                               FontSize="12"
                                               Foreground="{StaticResource White}"/>

                                    <TextBlock Text="{Binding GeneratedFilterSummary}"
                                               FontSize="10"
                                               Foreground="{StaticResource White}"
                                               TextWrapping="Wrap"/>

                                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8" Margin="0,4,0,0">
                                        <Button Grid.Column="0"
                                                Command="{Binding SaveFilterCommand}"
                                                Classes="btn-green"
                                                FontSize="11"
                                                Padding="8,4">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <icons:PackIconMaterial Kind="ContentSave" Width="12" Height="12" VerticalAlignment="Center"/>
                                                <TextBlock Text="Save" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Button>
                                        <Button Grid.Column="1"
                                                Command="{Binding SearchFilterCommand}"
                                                Classes="btn-blue"
                                                FontSize="11"
                                                Padding="8,4">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <icons:PackIconMaterial Kind="Magnify" Width="12" Height="12" VerticalAlignment="Center"/>
                                                <TextBlock Text="Search" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Button>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Quick Examples -->
                            <Expander FontSize="11">
                                <Expander.Header>
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <icons:PackIconMaterial Kind="LightbulbOn" Width="12" Height="12" VerticalAlignment="Center"/>
                                        <TextBlock Text="Example Prompts" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Expander.Header>
                                <StackPanel Spacing="6" Margin="0,8,0,0">
                                    <Button Content="Perkeo with Blueprint and Brainstorm"
                                            Command="{Binding UseExampleCommand}"
                                            CommandParameter="Find me a Ghost Deck seed with Perkeo soul joker, Blueprint, and Brainstorm in antes 1-3"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Background="Transparent"
                                            FontSize="10"
                                            Padding="6,4"/>
                                    <Button Content="Negative tags in early game"
                                            Command="{Binding UseExampleCommand}"
                                            CommandParameter="Get me seeds with Negative tags on antes 2 and 3"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Background="Transparent"
                                            FontSize="10"
                                            Padding="6,4"/>
                                    <Button Content="Economy build with vouchers"
                                            Command="{Binding UseExampleCommand}"
                                            CommandParameter="Green deck with Egg, Bull, and Observatory voucher"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Background="Transparent"
                                            FontSize="10"
                                            Padding="6,4"/>
                                    <Button Content="Avoid specific jokers"
                                            Command="{Binding UseExampleCommand}"
                                            CommandParameter="Any seed without Chicot or The Idol"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Background="Transparent"
                                            FontSize="10"
                                            Padding="6,4"/>
                                </StackPanel>
                            </Expander>

                        </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>
