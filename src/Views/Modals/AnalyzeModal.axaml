<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="using:BalatroSeedOracle.Controls"
             xmlns:components="using:BalatroSeedOracle.Components"
             xmlns:vm="using:BalatroSeedOracle.ViewModels"
             xmlns:models="using:BalatroSeedOracle.Models"
             xmlns:converters="using:BalatroSeedOracle.Converters"
             x:Class="BalatroSeedOracle.Views.Modals.AnalyzeModal"
             x:DataType="vm:AnalyzeModalViewModel">
    
    <UserControl.Resources>
        <converters:ShopItemSpriteConverter x:Key="ShopItemSpriteConverter"/>
        <converters:BoosterPackSpriteConverter x:Key="BoosterPackSpriteConverter"/>
        <converters:TagSpriteConverter x:Key="TagSpriteConverter"/>
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- Use global styles for tab buttons; removing modal-specific overrides -->
        
        <!-- Small button style -->
        <Style Selector="Button.small-button">
            <Setter Property="Background" Value="{StaticResource Blue}"/>
            <Setter Property="Foreground" Value="{StaticResource White}"/>
            <Setter Property="FontFamily" Value="{StaticResource BalatroFont}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Padding" Value="16,0"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.small-button:pointerover">
            <Setter Property="Background" Value="{StaticResource BlueHover}"/>
        </Style>
        
        <!-- Navigation arrow style -->
        <Style Selector="Button.nav-arrow">
            <Setter Property="Background" Value="{StaticResource Blue}"/>
            <Setter Property="Foreground" Value="{StaticResource White}"/>
            <Setter Property="FontFamily" Value="{StaticResource BalatroFont}"/>
            <Setter Property="FontSize" Value="26"/>
            
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style Selector="Button.nav-arrow:pointerover">
            <Setter Property="Background" Value="{StaticResource BlueHover}"/>
        </Style>
        
        <!-- Content box style -->
        <Style Selector="Border.content-box">
            <Setter Property="Background" Value="{StaticResource DarkModalGrey}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        
        <!-- Ante Panel Style -->
        <Style Selector="Border.ante-panel">
            <Setter Property="Background" Value="{StaticResource DarkModalGrey}"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Margin" Value="5,5,5,10"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        
        <!-- Shop Slot Style -->
        <Style Selector="Border.shop-slot">
            <Setter Property="Background" Value="{StaticResource VeryDarkGrey}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="MinWidth" Value="90"/>
            <Setter Property="MinHeight" Value="130"/>
        </Style>
        
        <!-- Tag Display Style -->
        <Style Selector="Border.tag-display">
            <Setter Property="Background" Value="{StaticResource VeryDarkGrey}"/>
            <Setter Property="CornerRadius" Value="20"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        
        <!-- Section Header Style -->
        <Style Selector="TextBlock.section-header">
            <Setter Property="FontSize" Value="24"/>

            <Setter Property="Margin" Value="0,0,0,15"/>
            <Setter Property="Foreground" Value="{StaticResource Gold}"/>
        </Style>
    </UserControl.Styles>

    <!-- DataTemplates -->
    <UserControl.DataTemplates>
        <!-- Shop Item Template -->
        <DataTemplate DataType="models:ShopItemModel">
            <Border Classes="shop-slot" Width="100" Height="140">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <!-- Item Sprite -->
                    <Image Source="{Binding Converter={StaticResource ShopItemSpriteConverter}}"
                           Width="71" Height="95"
                           Stretch="UniformToFill"/>

                    <!-- Edition Badge -->
                    <TextBlock Text="{Binding EditionName}"
                              FontSize="10"
                              HorizontalAlignment="Center"
                              Foreground="{Binding EditionColor}"
                              IsVisible="{Binding HasEdition}"/>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- Booster Pack Template -->
        <DataTemplate DataType="models:BoosterPackModel">
            <Border Classes="shop-slot" MinWidth="100" MaxWidth="150" MinHeight="140" Margin="4">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <!-- Pack Sprite -->
                    <Image Source="{Binding Converter={StaticResource BoosterPackSpriteConverter}}"
                           Width="71" Height="95"
                           Stretch="Uniform"/>

                    <!-- Pack Info -->
                    <StackPanel>
                        <TextBlock Text="{Binding PackName}"
                                  FontSize="10"
                                  HorizontalAlignment="Center"/>

                        <TextBlock Text="{Binding ItemsText}"
                                  FontSize="8"
                                  HorizontalAlignment="Center"
                                  TextWrapping="Wrap"
                                  MaxWidth="90"
                                  Opacity="0.8"
                                  Margin="0,2,0,0"
                                  IsVisible="{Binding HasItems}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- Tag Template -->
        <DataTemplate DataType="models:TagModel">
            <Border Classes="tag-display" Margin="4">
                <StackPanel Orientation="Horizontal">
                    <!-- Tag Sprite -->
                    <Image Source="{Binding Converter={StaticResource TagSpriteConverter}}"
                           Width="34" Height="34"
                           Stretch="UniformToFill"
                           Margin="0,0,8,0"/>

                    <!-- Tag Info -->
                    <StackPanel>
                        <TextBlock Text="{Binding BlindType}"
                                  FontSize="10"
                                  Opacity="0.7"/>
                        <TextBlock Text="{Binding TagName}"
                                  FontSize="12"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- Ante Template -->
        <DataTemplate DataType="models:AnteAnalysisModel">
            <Border Classes="ante-panel" Padding="20">
                <StackPanel>
                    <!-- Ante Header -->
                    <TextBlock Text="{Binding AnteTitle}" Classes="section-header"/>

                    <!-- Voucher Section -->
                    <StackPanel IsVisible="{Binding HasVoucher}">
                        <TextBlock Text="VOUCHER" FontSize="16" Margin="0,10,0,5"/>
                        <TextBlock Text="{Binding VoucherName}" FontSize="14" Margin="20,0,0,10"/>
                    </StackPanel>

                    <!-- Shop Section -->
                    <StackPanel IsVisible="{Binding HasShopItems}">
                        <TextBlock Text="SHOP" FontSize="16" Margin="0,10,0,5"/>
                        <ItemsControl ItemsSource="{Binding ShopItems}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </StackPanel>

                    <!-- Booster Packs Section -->
                    <StackPanel IsVisible="{Binding HasBoosterPacks}">
                        <TextBlock Text="BOOSTER PACKS" FontSize="16" Margin="0,15,0,5"/>
                        <ItemsControl ItemsSource="{Binding BoosterPacks}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </StackPanel>

                    <!-- Tags Section -->
                    <StackPanel>
                        <TextBlock Text="SKIP TAGS" FontSize="16" Margin="0,15,0,5"/>
                        <WrapPanel Orientation="Horizontal">
                            <ContentControl Content="{Binding SmallBlindTag}"/>
                            <ContentControl Content="{Binding BigBlindTag}"/>
                        </WrapPanel>
                    </StackPanel>
                </StackPanel>
            </Border>
        </DataTemplate>
    </UserControl.DataTemplates>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Triangle pointer -->
            <RowDefinition Height="Auto"/> <!-- Tabs -->
            <RowDefinition Height="*"/>    <!-- Content -->
        </Grid.RowDefinitions>
        
        <!-- Triangle pointer above tabs -->
        <Grid Grid.Row="0" HorizontalAlignment="Center" Height="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="148"/> <!-- DECK/STAKE -->
                <ColumnDefinition Width="148"/> <!-- ANALYZE -->
            </Grid.ColumnDefinitions>

            <!-- Triangle container with shadow and main triangle -->
            <Grid Grid.Column="{Binding TriangleColumn}"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Bottom">

                <!-- Drop shadow triangle -->
                <Polygon Points="10,20 20,5 0,5"
                         Fill="{StaticResource SemiTransparentShadow}"
                         Margin="2,2,0,0"/>

                <!-- Main triangle that bounces -->
                <Polygon Points="10,20 20,5 0,5"
                         Fill="{StaticResource Red}">
                    <Polygon.Styles>
                        <Style Selector="Polygon">
                            <Style.Animations>
                                <Animation Duration="0:0:1.2"
                                           IterationCount="Infinite"
                                           PlaybackDirection="Alternate"
                                           Easing="SineEaseInOut">
                                    <KeyFrame Cue="0%">
                                        <Setter Property="Margin" Value="0,0,0,0"/>
                                    </KeyFrame>
                                    <KeyFrame Cue="100%">
                                        <Setter Property="Margin" Value="0,-8,0,8"/>
                                    </KeyFrame>
                                </Animation>
                            </Style.Animations>
                        </Style>
                    </Polygon.Styles>
                </Polygon>
            </Grid>
        </Grid>
        
        <!-- Tab buttons -->
        <StackPanel Grid.Row="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    Margin="0,4,0,4">
            <Button Content="DECK/STAKE"
                    Classes="tab-button"
                    Classes.active="{Binding IsSettingsTabActive}"
                    Command="{Binding SwitchToSettingsTabCommand}"/>
            <Button Content="ANALYZE"
                    Classes="tab-button"
                    Classes.active="{Binding IsAnalyzerTabActive}"
                    Command="{Binding SwitchToAnalyzerTabCommand}"/>
        </StackPanel>
        
        <!-- Content panels -->
        <Grid Grid.Row="2">
            <!-- Settings Panel (Deck/Stake) -->
            <StackPanel IsVisible="{Binding SettingsTabVisible}" Spacing="24">
                <!-- Explanatory Text -->
                <TextBlock Text="Peek inside any seed to see what the shops, packs, and skip tags look like for each ante!"
                          FontFamily="{StaticResource BalatroFont}"
                          FontSize="13"
                          Foreground="{StaticResource VeryLightGrey}"
                          TextWrapping="Wrap"
                          HorizontalAlignment="Center"
                          TextAlignment="Center"
                          Opacity="0.8"
                          Margin="0,8,0,0"/>

                <Border Background="{StaticResource DarkModalGrey}"
                        CornerRadius="12"
                        Padding="40"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center">
                    <components:DeckAndStakeSelector Name="DeckAndStakeSelector"/>
                </Border>
            </StackPanel>
            
            <!-- Analyzer Panel -->
            <ScrollViewer IsVisible="{Binding AnalyzerTabVisible}" VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!-- Input Section -->
                    <Border Background="{StaticResource DarkModalGrey}" CornerRadius="12" Margin="10">
                        <Grid Margin="15" ColumnSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*" MaxWidth="300"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Seed Input -->
                            <TextBlock Grid.Column="0"
                                      Text="Seed:"
                                      VerticalAlignment="Center"
                                      Margin="0,0,10,0"
                                      FontSize="16"
                                      Foreground="{StaticResource White}"/>

                            <TextBox Grid.Column="1"
                                    Text="{Binding SeedInput}"
                                    FontSize="16"
                                    MaxLength="8"
                                    Watermark="Enter seed..."
                                    VerticalAlignment="Center"
                                    Height="40"
                                    Margin="0,0,15,0"
                                    CornerRadius="6"
                                    Background="{StaticResource VeryDarkGrey}"
                                    BorderBrush="{StaticResource DarkBorder}"
                                    BorderThickness="0"/>

                            <!-- Analyze Button -->
                            <Button Grid.Column="2"
                                   Content="ANALYZE"
                                   Command="{Binding AnalyzeSeedCommand}"
                                   MinWidth="120"
                                   Background="{StaticResource AccentGreen}"
                                   Foreground="{StaticResource White}"
                                   FontSize="16"
                                   CornerRadius="6"
                                   Height="44"
                                   Classes="btn-green"/>

                            <!-- Pop-out Analyzer Button -->
                            <Button Grid.Column="3"
                                   Content="POP-OUT"
                                   Command="{Binding PopOutAnalyzerCommand}"
                                   MinWidth="100"
                                   Background="{StaticResource Blue}"
                                   Foreground="{StaticResource White}"
                                   FontSize="16"
                                   CornerRadius="6"
                                   Height="44"
                                   Classes="btn-blue"/>
                        </Grid>
                    </Border>

                    <!-- Results Section -->
                    <StackPanel Margin="5">
                        <!-- Placeholder -->
                        <Border Background="{StaticResource DarkModalGrey}"
                               CornerRadius="12"
                               Padding="40"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Margin="20"
                               IsVisible="{Binding ShowPlaceholder}">
                            <StackPanel>
                                <TextBlock Text="ðŸŽ´"
                                          FontSize="48"
                                          HorizontalAlignment="Center"
                                          Margin="0,0,0,10"/>
                                <TextBlock Text="Enter a seed and click ANALYZE"
                                          HorizontalAlignment="Center"
                                          FontSize="18"
                                          Foreground="{StaticResource White}"/>
                                <TextBlock Text="View shop contents, booster packs, and skip tags for each ante"
                                          HorizontalAlignment="Center"
                                          FontSize="14"
                                          Margin="0,5,0,0"
                                          Opacity="0.7"/>
                            </StackPanel>
                        </Border>

                        <!-- Analysis Header -->
                        <StackPanel Margin="0,0,0,10" IsVisible="{Binding HasAnalysisResults}">
                            <TextBlock Text="{Binding AnalysisHeader}"
                                      FontSize="20"
                                      HorizontalAlignment="Center"
                                      Margin="0,10,0,5"/>
                        </StackPanel>

                        <!-- Ante Results -->
                        <ItemsControl ItemsSource="{Binding Antes}"/>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>