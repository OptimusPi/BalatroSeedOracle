<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BalatroSeedOracle.ViewModels"
             xmlns:components="using:BalatroSeedOracle.Components"
             xmlns:controls="using:BalatroSeedOracle.Controls"
             x:Class="BalatroSeedOracle.Views.Modals.SearchModal"
             x:DataType="vm:SearchModalViewModel">


    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Tab Navigation (Balatro style with bouncing triangle) -->
        <Grid Grid.Row="0" HorizontalAlignment="Center" Margin="0,0,0,-3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Tab Buttons (triangle built into button template - PERFECT centering!) -->
            <Button Name="SelectFilterTab"
                    Grid.Column="0"
                    Content="Select Filter"
                    Classes="tab-button active"
                    Click="OnTabClick"/>
            <Button Name="SettingsTab"
                    Grid.Column="1"
                    Content="Settings"
                    Classes="tab-button"
                    Click="OnTabClick"/>
            <Button Name="SearchTab"
                    Grid.Column="2"
                    Content="Search"
                    Classes="tab-button"
                    Click="OnTabClick"/>
            <Button Name="ResultsTab"
                    Grid.Column="3"
                    Content="Results"
                    Classes="tab-button"
                    Click="OnTabClick"/>
        </Grid>

        <!-- Content Area with Tab Panels (no border - StandardModal already has one!) -->
        <Border Grid.Row="1"
                Background="{StaticResource DarkModalGrey}"
                BorderThickness="0"
                CornerRadius="0,0,12,12"
                Padding="20"
                Margin="0,8,0,0">

            <!-- Container for all tab panels (Border can only have ONE child) -->
            <Grid>
                <!-- Select Filter Panel -->
                <Grid Name="SelectFilterPanel" IsVisible="{Binding IsSelectFilterTabVisible}">
                    <components:FilterSelectorControl Name="FilterSelector"
                                                    IsInSearchModal="True"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"/>
                </Grid>

                <!-- Settings Panel (Horizontal Split Layout) -->
                <Grid Name="SettingsPanel" IsVisible="{Binding IsSettingsTabVisible}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- LEFT SIDE: Preferred Deck & Stake -->
                    <StackPanel Grid.Column="0"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Spacing="16"
                               MaxWidth="450">
                        <TextBlock Text="SET PREFERRED DECK &amp; STAKE:"
                                  FontFamily="{StaticResource BalatroFont}"
                                  FontSize="18"
                                  Foreground="{StaticResource Gold}"
                                  HorizontalAlignment="Center"/>

                        <TextBlock Text="Choose your starting deck and difficulty. This helps the search engine find seeds that work best with your playstyle!"
                                  FontFamily="{StaticResource BalatroFont}"
                                  FontSize="13"
                                  Foreground="{StaticResource VeryLightGrey}"
                                  TextWrapping="Wrap"
                                  HorizontalAlignment="Center"
                                  TextAlignment="Center"
                                  Opacity="0.8"
                                  Margin="0,0,0,8"/>

                        <components:DeckAndStakeSelector Name="DeckStakeSelector"/>
                    </StackPanel>

                    <!-- RIGHT SIDE: Search Engine Options -->
                    <StackPanel Grid.Column="2"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Spacing="16">
                        <TextBlock Text="SEARCH ENGINE OPTIONS"
                                  FontFamily="{StaticResource BalatroFont}"
                                  FontSize="18"
                                  Foreground="{StaticResource Gold}"
                                  HorizontalAlignment="Center"/>

                        <Border Background="{StaticResource ContainerDarkPrecise}"
                                BorderBrush="{StaticResource ModalBorder}"
                                BorderThickness="2"
                                CornerRadius="8"
                                Padding="16"
                                MinWidth="320">
                            <StackPanel Spacing="16">
                                <!-- Thread Count -->
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0"
                                              Text="Threads:"
                                              FontFamily="{StaticResource BalatroFont}"
                                              FontSize="14"
                                              VerticalAlignment="Center"/>

                                    <controls:SpinnerControl Grid.Column="1"
                                                           Value="{Binding ThreadCount}"
                                                           Minimum="1"
                                                           Maximum="64"
                                                           Width="120"/>
                                </Grid>

                                <!-- Batch Size -->
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0"
                                              Text="Batch Size:"
                                              FontFamily="{StaticResource BalatroFont}"
                                              FontSize="14"
                                              VerticalAlignment="Center"/>

                                    <controls:SpinnerControl Grid.Column="1"
                                                           Value="{Binding BatchSize}"
                                                           Minimum="0"
                                                           Maximum="3"
                                                           Width="120"/>
                                </Grid>

                                <!-- Min Score -->
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0"
                                              Text="Min Score:"
                                              FontFamily="{StaticResource BalatroFont}"
                                              FontSize="14"
                                              VerticalAlignment="Center"/>

                                    <controls:SpinnerControl Grid.Column="1"
                                                           Value="{Binding MinScore}"
                                                           Minimum="0"
                                                           Maximum="100"
                                                           Width="120"/>
                                </Grid>

                                <!-- Debug Mode (Developer Feature) -->
                                <Border Background="{StaticResource DarkBackground}"
                                        BorderBrush="{StaticResource Orange}"
                                        BorderThickness="1"
                                        CornerRadius="4"
                                        Padding="8"
                                        IsVisible="{Binding DebugMode}">
                                    <StackPanel Spacing="6">
                                        <TextBlock Text="DEBUG MODE"
                                                  FontFamily="{StaticResource BalatroFont}"
                                                  FontSize="12"
                                                  Foreground="{StaticResource Orange}"
                                                  HorizontalAlignment="Center"/>
                                        <TextBox Text="{Binding DebugSeed}"
                                                Watermark="Enter seed..."
                                                FontFamily="{StaticResource BalatroFont}"
                                                FontSize="12"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Grid>

            <!-- Search Panel -->
            <Grid Name="SearchPanel" IsVisible="{Binding IsSearchTabVisible}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="16"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="16"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Search Status Header (Balatro style - NO BORDER!) -->
                <StackPanel Grid.Row="0" Spacing="8">
                    <TextBlock Text="{Binding FilterName}"
                              FontFamily="{StaticResource BalatroFont}"
                              FontSize="20"
                              Foreground="{StaticResource Gold}"
                              HorizontalAlignment="Center"/>

                    <ProgressBar Value="{Binding ProgressPercent}"
                                Maximum="100"
                                Height="24"
                                Background="{StaticResource DarkBackground}"
                                Foreground="{StaticResource Green}"/>
                </StackPanel>

                <!-- Stats Grid -->
                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="16"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left Stats (Balatro style - NO BORDER!) -->
                    <StackPanel Grid.Column="0" Spacing="12">
                        <TextBlock Text="PROGRESS"
                                  FontFamily="{StaticResource BalatroFont}"
                                  FontSize="16"
                                  Foreground="{StaticResource Gold}"
                                  HorizontalAlignment="Center"/>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="8"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="8"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="8"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Seeds Processed:" FontFamily="{StaticResource BalatroFont}"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SeedsProcessed}" FontFamily="{StaticResource BalatroFont}" Foreground="{StaticResource White}"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Results Found:" FontFamily="{StaticResource BalatroFont}"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding ResultsFound}" FontFamily="{StaticResource BalatroFont}" Foreground="{StaticResource Green}"/>

                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Time Elapsed:" FontFamily="{StaticResource BalatroFont}"/>
                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding TimeElapsed, StringFormat='{}{0:hh\\:mm\\:ss}'}" FontFamily="{StaticResource BalatroFont}"/>

                            <TextBlock Grid.Row="6" Grid.Column="0" Text="ETA:" FontFamily="{StaticResource BalatroFont}"/>
                            <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding EstimatedTimeRemaining, StringFormat='{}{0:hh\\:mm\\:ss}'}" FontFamily="{StaticResource BalatroFont}"/>
                        </Grid>
                    </StackPanel>

                    <!-- Right Stats -->
                    <Border Grid.Column="2"
                           Background="{StaticResource ContainerDarkPrecise}"
                           BorderBrush="{StaticResource ModalBorder}"
                           BorderThickness="2"
                           CornerRadius="8"
                           Padding="16">
                        <StackPanel Spacing="12">
                            <TextBlock Text="PERFORMANCE"
                                      FontFamily="{StaticResource BalatroFont}"
                                      FontSize="16"
                                      Foreground="{StaticResource Gold}"
                                      HorizontalAlignment="Center"/>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="150"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="8"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Current Speed:" FontFamily="{StaticResource BalatroFont}"/>
                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SeedsPerSecond, StringFormat='{}{0:N0} seeds/sec'}" FontFamily="{StaticResource BalatroFont}" Foreground="{StaticResource White}"/>

                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Avg Speed:" FontFamily="{StaticResource BalatroFont}"/>
                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding AverageSpeed, StringFormat='{}{0:N0} seeds/sec'}" FontFamily="{StaticResource BalatroFont}"/>
                            </Grid>
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Search Control Buttons -->
                <StackPanel Grid.Row="4"
                           Orientation="Horizontal"
                           HorizontalAlignment="Center"
                           Spacing="12">
                    <Button Content="Start Search"
                           Command="{Binding StartSearchCommand}"
                           Classes="btn-green"
                           MinWidth="150"
                           MinHeight="40"/>
                    <Button Content="Pause"
                           Command="{Binding PauseSearchCommand}"
                           Classes="btn-orange"
                           MinWidth="150"
                           MinHeight="40"/>
                    <Button Content="Stop"
                           Command="{Binding StopSearchCommand}"
                           Classes="btn-red"
                           MinWidth="150"
                           MinHeight="40"/>
                </StackPanel>
            </Grid>

            <!-- Results Panel -->
            <Grid Name="ResultsPanel" IsVisible="{Binding IsResultsTabVisible}">
                <ScrollViewer>
                    <DataGrid ItemsSource="{Binding SearchResults}"
                             AutoGenerateColumns="False"
                             IsReadOnly="True"
                             GridLinesVisibility="All"
                             BorderThickness="1"
                             BorderBrush="{StaticResource ModalBorder}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Seed" Binding="{Binding Seed}" Width="150"/>
                            <DataGridTextColumn Header="Score" Binding="{Binding Score}" Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </ScrollViewer>
            </Grid>

            </Grid><!-- Close container Grid for all tab panels -->
        </Border>
    </Grid>
</UserControl>
