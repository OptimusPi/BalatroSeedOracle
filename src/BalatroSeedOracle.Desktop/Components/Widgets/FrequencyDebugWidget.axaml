<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BalatroSeedOracle.ViewModels"
             xmlns:i="using:Avalonia.Xaml.Interactivity"
             xmlns:behaviors="using:BalatroSeedOracle.Behaviors"
             xmlns:conv="using:BalatroSeedOracle.Converters"
             xmlns:local="using:BalatroSeedOracle.Components"
             xmlns:material="clr-namespace:IconPacks.Avalonia.Material;assembly=IconPacks.Avalonia.Material"
             xmlns:icons="clr-namespace:IconPacks.Avalonia.Material;assembly=IconPacks.Avalonia.Material"
             x:Class="BalatroSeedOracle.Desktop.Components.Widgets.FrequencyDebugWidget"
             x:DataType="vm:FrequencyDebugWidgetViewModel"
             x:CompileBindings="True"
             Panel.ZIndex="{Binding WidgetZIndex}">

    <UserControl.Resources>
        <conv:BoolToLedColorConverter x:Key="BoolToLedColor"/>
    </UserControl.Resources>

    <!-- Single container with drag behavior -->
    <Grid HorizontalAlignment="Left" VerticalAlignment="Top">
        <i:Interaction.Behaviors>
            <behaviors:DraggableWidgetBehavior X="{Binding PositionX, Mode=TwoWay}"
                                               Y="{Binding PositionY, Mode=TwoWay}"
                                               DragHandleClass="widget-header" />
        </i:Interaction.Behaviors>

        <!-- Minimized State - Compact Icon -->
        <StackPanel IsVisible="{Binding IsMinimized}"
                    Spacing="4">
            <i:Interaction.Behaviors>
                <behaviors:BalatroCardSwayBehavior AmbientTilt="0.2" />
            </i:Interaction.Behaviors>

            <Border Background="{StaticResource ModalGrey}"
                    BorderBrush="{StaticResource ModalBorder}"
                    BorderThickness="2"
                    CornerRadius="8"
                    Width="64" Height="64"
                    Classes="widget-header"
                    Cursor="Hand"
                    PointerPressed="OnMinimizedIconPressed"
                    PointerReleased="OnMinimizedIconReleased">
                <icons:PackIconMaterial Kind="ChartBar" Width="28" Height="28" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="White"/>
            </Border>
            <TextBlock Text="FFT"
                       FontSize="16"

                       Foreground="White"
                       HorizontalAlignment="Center"/>
        </StackPanel>

        <!-- Expanded State - Frequency Debug Panel -->
        <Border Classes="widget-window"
                IsVisible="{Binding !IsMinimized}"
                MinWidth="320"
                MaxWidth="380"
                MaxHeight="650">

            <Grid RowDefinitions="Auto,*">
                <!-- Header using shared component -->
                <local:WidgetHeader Grid.Row="0" />

                <!-- Content Area with ScrollViewer -->
                <ScrollViewer Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Margin="15" Spacing="12">

                    <!-- Track Selector -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="TRACK" Foreground="{StaticResource White}" FontSize="16"/>
                        <ComboBox SelectedIndex="{Binding SelectedTrackIndex}" HorizontalAlignment="Stretch" FontSize="14">
                            <ComboBoxItem Content="Bass1"/>
                            <ComboBoxItem Content="Bass2"/>
                            <ComboBoxItem Content="Drums1"/>
                            <ComboBoxItem Content="Drums2"/>
                            <ComboBoxItem Content="Chords1"/>
                            <ComboBoxItem Content="Chords2"/>
                            <ComboBoxItem Content="Melody1"/>
                            <ComboBoxItem Content="Melody2"/>
                        </ComboBox>
                    </StackPanel>

                    <!-- BASS RANGE: 20-250 Hz -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="BASS (20-250 Hz)" Foreground="{StaticResource White}" FontSize="15"/>

                        <!-- Bass Average -->
                        <Grid ColumnDefinitions="60,*,60">
                            <TextBlock Grid.Column="0" Text="Avg" Foreground="{StaticResource White}" FontSize="14" VerticalAlignment="Center"/>
                            <ProgressBar Grid.Column="1" Value="{Binding BassAvg}" Maximum="1" Height="18" Margin="4,0"/>
                            <TextBlock Grid.Column="2" Text="{Binding BassAvg, StringFormat='{}{0:F3}'}"
                                       Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="14"
                                       HorizontalAlignment="Right" VerticalAlignment="Center"/>
                        </Grid>

                        <!-- Bass Peak -->
                        <Grid ColumnDefinitions="60,*,60">
                            <TextBlock Grid.Column="0" Text="Peak" Foreground="{StaticResource White}" FontSize="14" VerticalAlignment="Center"/>
                            <ProgressBar Grid.Column="1" Value="{Binding BassPeak}" Maximum="1" Height="18" Margin="4,0"/>
                            <TextBlock Grid.Column="2" Text="{Binding BassPeak, StringFormat='{}{0:F3}'}"
                                       Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="14"
                                       HorizontalAlignment="Right" VerticalAlignment="Center"/>
                        </Grid>
                    </StackPanel>

                    <!-- MID RANGE: 250-2000 Hz -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="MID (250-2000 Hz)" Foreground="{StaticResource White}" FontSize="15"/>

                        <!-- Mid Average -->
                        <Grid ColumnDefinitions="60,*,60">
                            <TextBlock Grid.Column="0" Text="Avg" Foreground="{StaticResource White}" FontSize="14" VerticalAlignment="Center"/>
                            <ProgressBar Grid.Column="1" Value="{Binding MidAvg}" Maximum="1" Height="18" Margin="4,0"/>
                            <TextBlock Grid.Column="2" Text="{Binding MidAvg, StringFormat='{}{0:F3}'}"
                                       Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="14"
                                       HorizontalAlignment="Right" VerticalAlignment="Center"/>
                        </Grid>

                        <!-- Mid Peak -->
                        <Grid ColumnDefinitions="60,*,60">
                            <TextBlock Grid.Column="0" Text="Peak" Foreground="{StaticResource White}" FontSize="14" VerticalAlignment="Center"/>
                            <ProgressBar Grid.Column="1" Value="{Binding MidPeak}" Maximum="1" Height="18" Margin="4,0"/>
                            <TextBlock Grid.Column="2" Text="{Binding MidPeak, StringFormat='{}{0:F3}'}"
                                       Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="14"
                                       HorizontalAlignment="Right" VerticalAlignment="Center"/>
                        </Grid>
                    </StackPanel>

                    <!-- HIGH RANGE: 2000-20000 Hz -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="HIGH (2000-20000 Hz)" Foreground="{StaticResource White}" FontSize="15"/>

                        <!-- High Average -->
                        <Grid ColumnDefinitions="60,*,60">
                            <TextBlock Grid.Column="0" Text="Avg" Foreground="{StaticResource White}" FontSize="14" VerticalAlignment="Center"/>
                            <ProgressBar Grid.Column="1" Value="{Binding HighAvg}" Maximum="1" Height="18" Margin="4,0"/>
                            <TextBlock Grid.Column="2" Text="{Binding HighAvg, StringFormat='{}{0:F3}'}"
                                       Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="14"
                                       HorizontalAlignment="Right" VerticalAlignment="Center"/>
                        </Grid>

                        <!-- High Peak -->
                        <Grid ColumnDefinitions="60,*,60">
                            <TextBlock Grid.Column="0" Text="Peak" Foreground="{StaticResource White}" FontSize="14" VerticalAlignment="Center"/>
                            <ProgressBar Grid.Column="1" Value="{Binding HighPeak}" Maximum="1" Height="18" Margin="4,0"/>
                            <TextBlock Grid.Column="2" Text="{Binding HighPeak, StringFormat='{}{0:F3}'}"
                                       Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="14"
                                       HorizontalAlignment="Right" VerticalAlignment="Center"/>
                        </Grid>
                    </StackPanel>

                    <!-- CAPTURED MAX VALUES -->
                    <Border BorderBrush="{StaticResource ModalBorder}" BorderThickness="2" CornerRadius="6" Padding="10" Background="{StaticResource VeryDarkGrey}">
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0" Text="CAPTURED MAX VALUES" Foreground="{StaticResource White}" FontSize="14"/>
                                <Button Grid.Column="1" Content="Reset" Classes="btn-red" FontSize="12" Padding="8,4" Command="{Binding ResetMaxValuesCommand}"/>
                            </Grid>

                            <!-- Bass Max Values with LED and Threshold -->
                            <StackPanel Spacing="4">
                                <Grid ColumnDefinitions="45,*,*,32" RowDefinitions="Auto">
                                    <TextBlock Grid.Column="0" Text="BASS" Foreground="{StaticResource White}" FontSize="13" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1" Text="{Binding BassAvgMax, StringFormat='Avg: {0:F3}'}"
                                               Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="12" Margin="4,0"/>
                                    <TextBlock Grid.Column="2" Text="{Binding BassPeakMax, StringFormat='Peak: {0:F3}'}"
                                               Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="12" Margin="4,0"/>
                                    <!-- LED Indicator -->
                                    <Ellipse Grid.Column="3" Width="20" Height="20" HorizontalAlignment="Right" Margin="6,0,0,0">
                                        <Ellipse.Fill>
                                            <SolidColorBrush Color="{Binding BassBeatBrightness, Converter={StaticResource BoolToLedColor}}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Grid>
                                <Grid ColumnDefinitions="Auto,*,50,32">
                                    <TextBlock Grid.Column="0" Text="Trigger:" Foreground="{StaticResource LightTextGrey}" FontSize="12" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                    <Slider Grid.Column="1" Value="{Binding BassThreshold}" Minimum="0" Maximum="{Binding BassPeakMax}" Height="14" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding BassThreshold, StringFormat='{}{0:F2}'}"
                                               Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="12" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    <Button Grid.Column="3" Content="+" Classes="btn-green" FontSize="16" 
                                            Width="26" Height="26" Padding="0" Margin="4,0,0,0"
                                            Command="{Binding SaveBassTriggerPointCommand}"
                                            ToolTip.Tip="Save trigger point"/>
                                </Grid>
                            </StackPanel>

                            <!-- Mid Max Values with LED and Threshold -->
                            <StackPanel Spacing="4">
                                <Grid ColumnDefinitions="45,*,*,32" RowDefinitions="Auto">
                                    <TextBlock Grid.Column="0" Text="MID" Foreground="{StaticResource White}" FontSize="13" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1" Text="{Binding MidAvgMax, StringFormat='Avg: {0:F3}'}"
                                               Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="12" Margin="4,0"/>
                                    <TextBlock Grid.Column="2" Text="{Binding MidPeakMax, StringFormat='Peak: {0:F3}'}"
                                               Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="12" Margin="4,0"/>
                                    <!-- LED Indicator -->
                                    <Ellipse Grid.Column="3" Width="20" Height="20" HorizontalAlignment="Right" Margin="6,0,0,0">
                                        <Ellipse.Fill>
                                            <SolidColorBrush Color="{Binding MidBeatBrightness, Converter={StaticResource BoolToLedColor}}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Grid>
                                <Grid ColumnDefinitions="Auto,*,50,32">
                                    <TextBlock Grid.Column="0" Text="Trigger:" Foreground="{StaticResource LightTextGrey}" FontSize="12" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                    <Slider Grid.Column="1" Value="{Binding MidThreshold}" Minimum="0" Maximum="{Binding MidPeakMax}" Height="14" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding MidThreshold, StringFormat='{}{0:F2}'}"
                                               Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="12" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    <Button Grid.Column="3" Content="+" Classes="btn-green" FontSize="16" 
                                            Width="26" Height="26" Padding="0" Margin="4,0,0,0"
                                            Command="{Binding SaveMidTriggerPointCommand}"
                                            ToolTip.Tip="Save trigger point"/>
                                </Grid>
                            </StackPanel>

                            <!-- High Max Values with LED and Threshold -->
                            <StackPanel Spacing="4">
                                <Grid ColumnDefinitions="45,*,*,32" RowDefinitions="Auto">
                                    <TextBlock Grid.Column="0" Text="HIGH" Foreground="{StaticResource White}" FontSize="13" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1" Text="{Binding HighAvgMax, StringFormat='Avg: {0:F3}'}"
                                               Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="12" Margin="4,0"/>
                                    <TextBlock Grid.Column="2" Text="{Binding HighPeakMax, StringFormat='Peak: {0:F3}'}"
                                               Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="12" Margin="4,0"/>
                                    <!-- LED Indicator -->
                                    <Ellipse Grid.Column="3" Width="20" Height="20" HorizontalAlignment="Right" Margin="6,0,0,0">
                                        <Ellipse.Fill>
                                            <SolidColorBrush Color="{Binding HighBeatBrightness, Converter={StaticResource BoolToLedColor}}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Grid>
                                <Grid ColumnDefinitions="Auto,*,50,32">
                                    <TextBlock Grid.Column="0" Text="Trigger:" Foreground="{StaticResource LightTextGrey}" FontSize="12" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                    <Slider Grid.Column="1" Value="{Binding HighThreshold}" Minimum="0" Maximum="{Binding HighPeakMax}" Height="14" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding HighThreshold, StringFormat='{}{0:F2}'}"
                                               Foreground="{StaticResource White}" FontFamily="Consolas" FontSize="12" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    <Button Grid.Column="3" Content="+" Classes="btn-green" FontSize="16" 
                                            Width="26" Height="26" Padding="0" Margin="4,0,0,0"
                                            Command="{Binding SaveHighTriggerPointCommand}"
                                            ToolTip.Tip="Save trigger point"/>
                                </Grid>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>
