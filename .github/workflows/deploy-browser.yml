name: Deploy Browser Version

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  DOTNET_VERSION: "10.0.x"
  PUBLISH_DIR: src/BalatroSeedOracle.Browser/bin/Release/net10.0-browser/publish/wwwroot

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet Packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore & Publish
        run: |
          dotnet restore
          dotnet publish src/BalatroSeedOracle.Browser/BalatroSeedOracle.Browser.csproj -c Release

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: browser-build-${{ github.ref_name }}
          path: ${{ env.PUBLISH_DIR }}
          retention-days: 30

      - name: Deploy to Vercel (Staging)
        if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          if [ -n "$VERCEL_TOKEN" ]; then
            echo "Deploying to Vercel..."
            npx vercel deploy ${{ env.PUBLISH_DIR }} --token=$VERCEL_TOKEN --prod
          else
            echo "VERCEL_TOKEN not configured, skipping Vercel deployment"
          fi

      - name: Deploy to Cloudflare Pages (Production)
        if: github.event.inputs.environment == 'production'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            echo "Deploying to Cloudflare Pages..."
            npx wrangler pages deploy ${{ env.PUBLISH_DIR }} --project-name=balatro-seed-oracle
          else
            echo "CLOUDFLARE_API_TOKEN not configured, skipping Cloudflare deployment"
          fi
