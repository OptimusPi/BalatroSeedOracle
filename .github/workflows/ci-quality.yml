name: CI Quality Gates

on:
  pull_request:
    branches: [ main, develop, 'v*' ]
  workflow_dispatch:

# Cancel in-progress runs when a new commit is pushed to the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Install CSharpier
      run: dotnet tool install --local csharpier --version 0.30.2

    - name: Check CSharpier Formatting
      run: dotnet csharpier format ./src --config-path .config/csharpierrc --check --no-msbuild-check

    - name: Setup dprint
      uses: dprint/check@v2.2
      with:
        config-path: .config/dprint.json

  build:
    name: Build Check
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]
        include:
          - os: windows-latest
            build-browser: true
          - os: ubuntu-latest
            build-browser: false

    steps:
    - name: Checkout Repository (with submodules)
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Install Required Workloads
      run: dotnet workload install android ios

    - name: Restore Core Library
      run: dotnet restore src/BalatroSeedOracle/BalatroSeedOracle.csproj /p:TargetFramework=net10.0

    - name: Restore Desktop
      run: dotnet restore src/BalatroSeedOracle.Desktop/BalatroSeedOracle.Desktop.csproj

    - name: Restore Browser
      run: dotnet restore src/BalatroSeedOracle.Browser/BalatroSeedOracle.Browser.csproj /p:TargetFramework=net10.0-browser

    - name: Build Core Library (with warnings as errors)
      run: dotnet build src/BalatroSeedOracle/BalatroSeedOracle.csproj -c Release --no-restore /p:TargetFramework=net10.0 -p:TreatWarningsAsErrors=true

    - name: Build Desktop
      run: dotnet build src/BalatroSeedOracle.Desktop/BalatroSeedOracle.Desktop.csproj -c Release --no-restore

    - name: Publish Browser (Windows only)
      if: matrix.build-browser
      run: dotnet publish src/BalatroSeedOracle.Browser/BalatroSeedOracle.Browser.csproj -c Release --no-restore /p:TargetFramework=net10.0-browser

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository (with submodules)
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Install Required Workloads
      run: dotnet workload install android ios

    - name: Restore Dependencies
      run: dotnet restore tests/BalatroSeedOracle.Tests/BalatroSeedOracle.Tests.csproj

    - name: Run Tests with Coverage
      run: dotnet test tests/BalatroSeedOracle.Tests/BalatroSeedOracle.Tests.csproj -c Release --no-restore --collect:"XPlat Code Coverage" --results-directory ./coverage

    - name: Upload Coverage Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: ./coverage/**/coverage.cobertura.xml
        retention-days: 30
