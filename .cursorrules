# Balatro Seed Oracle - Cursor AI Rules

## Project Overview
Cross-platform Avalonia UI seed searcher for Balatro. .NET 10, MVVM, AOT-ready.

## Platforms (Avalonia UI - NOT MAUI/Xamarin)
| Platform | Project | Target | Status |
|----------|---------|--------|--------|
| Windows/macOS/Linux | `.Desktop` | `net10.0` | ‚úÖ Primary |
| Browser (WASM) | `.Browser` | `net10.0-browser` | ‚úÖ Active |
| Android | `.Android` | `net10.0-android` | üìã Scaffold |
| iOS | `.iOS` | `net10.0-ios` | üìã Scaffold |

---

## ‚ö†Ô∏è CRITICAL RULES - NEVER BREAK

### 1. Logging
```csharp
// ‚úÖ CORRECT - Always use DebugLogger
DebugLogger.Log("Component", "message");
DebugLogger.LogError("Component", "error message");
DebugLogger.LogImportant("Component", "important message");

// ‚ùå WRONG - Never use Console
Console.WriteLine("anything");  // FORBIDDEN
```
Location: `src/BalatroSeedOracle/Helpers/DebugLogger.cs`

### 2. ViewModels - Use CommunityToolkit.Mvvm
```csharp
// ‚úÖ CORRECT
public partial class MyViewModel : ObservableObject
{
    [ObservableProperty]
    private string _myProperty = "";
    
    [RelayCommand]
    private void DoSomething() { }
}

// ‚ùå WRONG - Do not use BaseViewModel (deprecated)
public class MyViewModel : BaseViewModel { }
```

### 3. Compiled Bindings (AOT-Critical)
```xml
<!-- ‚úÖ CORRECT - Both attributes required -->
<UserControl x:CompileBindings="True"
             x:DataType="vm:MyViewModel">
    <TextBlock Text="{Binding Name}"/>
</UserControl>

<!-- ‚ùå WRONG - CompileBindings without DataType = runtime crash -->
<UserControl x:CompileBindings="True">
    <TextBlock Text="{Binding Name}"/>  <!-- üí• AVLN2000 error -->
</UserControl>

<!-- ‚ö†Ô∏è EXCEPTION - Controls binding to own StyledProperties -->
<!-- Some controls (spinners, custom controls) should NOT use x:CompileBindings -->
```

### 4. Platform Code - DI Abstractions Only
```
src/BalatroSeedOracle/           ‚Üí Shared (interfaces, ViewModels, Views)
src/BalatroSeedOracle.Desktop/   ‚Üí Desktop implementations
src/BalatroSeedOracle.Browser/   ‚Üí Browser implementations (JS interop)
src/BalatroSeedOracle.Android/   ‚Üí Android implementations
src/BalatroSeedOracle.iOS/       ‚Üí iOS implementations
```

```csharp
// ‚úÖ CORRECT - Define interface in shared, implement per-platform
public interface IAudioManager { Task PlayAsync(string sound); }

// Desktop/Services/DesktopAudioManager.cs
public class DesktopAudioManager : IAudioManager { /* NAudio/etc */ }

// Browser/Services/BrowserAudioManager.cs  
public class BrowserAudioManager : IAudioManager { /* JS interop */ }

// ‚ùå WRONG - Conditional compilation
#if BROWSER  // NEVER DO THIS
    // browser code
#endif
```

### 5. No FindControl - Use x:Name or Bindings
```csharp
// ‚ùå WRONG - Service locator anti-pattern
var button = this.FindControl<Button>("MyButton");
button.Content = "Hello";

// ‚úÖ CORRECT - Direct field access via x:Name
// In XAML: <Button x:Name="MyButton"/>
// In code-behind: MyButton.Content = "Hello";  // Field auto-generated

// ‚úÖ BEST - Use bindings
// <Button Content="{Binding ButtonText}"/>
```

### 6. UI Thread Updates
```csharp
// ‚úÖ CORRECT - Use Dispatcher for UI updates from background threads
await Dispatcher.UIThread.InvokeAsync(() => 
{
    MyProperty = newValue;
});

// ‚ùå WRONG - Direct property update from background thread
Task.Run(() => MyProperty = value);  // May crash
```

### 7. Async Patterns
```csharp
// ‚úÖ CORRECT
public async Task DoWorkAsync()
{
    await SomeOperationAsync().ConfigureAwait(false);
}

public Task DoNothingAsync() => Task.CompletedTask;  // No async keyword

// ‚ùå WRONG
public async Task DoNothingAsync() { }  // Warning: no await
```

---

## Architecture

### MVVM Structure
```
ViewModels/     ‚Üí ObservableObject derivatives, [ObservableProperty], [RelayCommand]
Views/          ‚Üí .axaml files with x:CompileBindings + x:DataType
Components/     ‚Üí Reusable UI controls
Controls/       ‚Üí Custom Avalonia controls with StyledProperties
Services/       ‚Üí Business logic, injected via DI
Models/         ‚Üí Data classes
Helpers/        ‚Üí Static utilities (DebugLogger, AppPaths)
```

### Dependency Injection
```csharp
// Platform Program.cs registers platform-specific services
PlatformServices.RegisterServices = services =>
{
    services.AddSingleton<IAppDataStore, DesktopAppDataStore>();
    services.AddSingleton<IAudioManager, DesktopAudioManager>();
    services.AddSingleton<IDuckDBService, DesktopDuckDBService>();
};

// Shared App.axaml.cs registers shared services
var services = new ServiceCollection();
services.AddSingleton<SearchManager>();
services.AddSingleton<FilterService>();
services.AddSingleton<SpriteService>();
PlatformServices.RegisterServices?.Invoke(services);
```

### Key Interfaces
| Interface | Desktop | Browser | Purpose |
|-----------|---------|---------|---------|
| `IAppDataStore` | File system | IndexedDB | Persistent storage |
| `IAudioManager` | NAudio/SoundFlow | Web Audio API | Sound playback |
| `IDuckDBService` | DuckDB.NET | In-memory | Seed database |
| `IPlatformServices` | System.IO | JS interop | Platform utils |

---

## WebAssembly (Browser) 

### Setup Requirements
```bash
# Install workloads FIRST
dotnet workload install wasm-tools wasm-experimental

# Build
dotnet publish src/BalatroSeedOracle.Browser -c Release

# Output location (CRITICAL - use this path everywhere)
src/BalatroSeedOracle.Browser/bin/Release/net10.0-browser/publish/wwwroot/
```

### Limitations
- ‚ùå No `System.IO.File` - use `IAppDataStore` or `IStorageProvider`
- ‚ùå No native DuckDB - use in-memory implementation
- ‚ùå Threading requires COOP/COEP headers
- ‚úÖ Use `[JSImport]`/`[JSExport]` for JS interop

### File Access Pattern
```csharp
// ‚úÖ CORRECT - Use Avalonia's IStorageProvider
var provider = TopLevel.GetTopLevel(this)?.StorageProvider;
var file = await provider.OpenFilePickerAsync(new FilePickerOpenOptions());

// ‚ùå WRONG - Won't work in browser
File.ReadAllText("path");
```

---

## AOT & Trimming

### TrimmerRoots.xml
Preserve types from aggressive trimming:
```xml
<linker>
  <assembly fullname="BalatroSeedOracle">
    <type fullname="BalatroSeedOracle.ViewModels*" preserve="all"/>
    <type fullname="BalatroSeedOracle.Models*" preserve="all"/>
    <type fullname="BalatroSeedOracle.Services*" preserve="all"/>
  </assembly>
</linker>
```

### AOT Compatibility
- ‚úÖ Use source generators (`[ObservableProperty]`, `[RelayCommand]`)
- ‚úÖ Use compiled bindings (`x:CompileBindings="True"`)
- ‚ùå Avoid reflection-based serialization without source generators
- ‚ùå Avoid `dynamic` keyword

---

## Build Commands

```bash
# Desktop (Windows AOT)
dotnet publish src/BalatroSeedOracle.Desktop -c Release -r win-x64

# Desktop (macOS ARM)
dotnet publish src/BalatroSeedOracle.Desktop -c Release -r osx-arm64

# Browser WASM
dotnet publish src/BalatroSeedOracle.Browser -c Release

# Run Desktop (dev)
dotnet run --project src/BalatroSeedOracle.Desktop

# Run Browser (dev)
dotnet run --project src/BalatroSeedOracle.Browser
```

---

## CI/CD & Deployment

### GitHub Secrets Required
```
AVALONIA_LICENSE_KEY    ‚Üí Avalonia UI license (set via env var, NEVER commit)
VERCEL_TOKEN            ‚Üí Vercel deployment token
CLOUDFLARE_API_TOKEN    ‚Üí Cloudflare Pages token
CLOUDFLARE_ACCOUNT_ID   ‚Üí Cloudflare account ID
```

### Workflow Files
| File | Purpose |
|------|---------|
| `build-browser.yml` | Build & artifact WASM |
| `deploy-browser.yml` | Deploy to Vercel/Cloudflare |
| `release-*.yml` | Platform releases |

### WASM Deploy Path
Always deploy from: `src/BalatroSeedOracle.Browser/bin/Release/net10.0-browser/publish/wwwroot/`

---

## Domain Knowledge

### JAML (Joker Ante Markup Language)
YAML-based seed filter format.
- Schema: `jaml.schema.json`
- Supports anchors (`&name`) and aliases (`*name`)
- Location: `JamlFilters/` directory

```yaml
# Example JAML filter
filter:
  name: "Early Legendary"
  ante: 1
  jokers:
    - &legendary_joker
      rarity: Legendary
      source: [Shop, Buffoon]
```

### Motely Search Engine
- Submodule: `external/Motely/`
- High-performance SIMD seed search
- DuckDB integration for result storage

### Balatro Concepts
| Term | Description |
|------|-------------|
| Joker | Cards that modify scoring/gameplay |
| Ante | Round (1-8, sometimes 1-12) |
| Blind | Boss at end of ante |
| Tag | Modifier (Skip, Negative, etc.) |
| Voucher | Shop upgrade |
| Edition | Foil, Holographic, Polychrome, Negative |

---

## Code Style

### Naming
- ViewModels: `*ViewModel`
- Services: `*Service`
- Platform: `Desktop*`, `Browser*`, `Android*`, `iOS*`
- Commands: `*Command`
- Private fields: `_camelCase`

### Nullability
```csharp
// ‚úÖ CORRECT
if (value is null) { }
if (value is not null) { }
var result = obj?.Property ?? defaultValue;

// ‚ùå WRONG
if (value == null) { }
```

---

## Common Errors & Fixes

| Error | Cause | Fix |
|-------|-------|-----|
| `AVLN2000` | Missing `x:DataType` with compiled bindings | Add `x:DataType="vm:YourViewModel"` |
| `AVLN2100` | Binding to non-existent property | Check property exists and is public |
| `CS8602` | Null dereference | Add null checks or use `?.` |
| `libSkiaSharp not found` | Missing WASM workload | `dotnet workload install wasm-tools` |
| Blank screen (WASM) | Initialization error | Check browser console, verify DI registration |

---

## File Locations

### Entry Points
- `src/BalatroSeedOracle.Desktop/Program.cs` ‚Üí Desktop
- `src/BalatroSeedOracle.Browser/Program.cs` ‚Üí Browser
- `src/BalatroSeedOracle/App.axaml.cs` ‚Üí Shared initialization

### Config Files
- `Directory.Build.props` ‚Üí Shared MSBuild properties
- `Directory.Packages.props` ‚Üí Central package versions
- `TrimmerRoots.xml` ‚Üí AOT preservation
- `vercel.json` ‚Üí Vercel deployment config
- `wrangler.toml` ‚Üí Cloudflare Pages config

---

**Avalonia Docs**: https://docs.avaloniaui.net/
**Last Updated**: 2026-01-28
